<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Mia Agenda - Google Calendar Integrata</title>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .sync-indicator.connected { background: #27ae60; }
        .sync-indicator.syncing { background: #f39c12; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .sync-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .sync-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 0;
            min-height: 800px;
        }

        .calendar-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 30px;
            overflow-y: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .current-month {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #bdc3c7;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .calendar-day-header {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ecf0f1;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: #e8f4fd;
            transform: scale(1.02);
        }

        .calendar-day.selected {
            background: #3498db;
            color: white;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #bdc3c7;
        }

        .calendar-day.today {
            background: #f39c12;
            color: white;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .day-events {
            font-size: 0.8em;
        }

        .event-item {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .event-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .event-item.work { background: #3498db; }
        .event-item.personal { background: #27ae60; }
        .event-item.medical { background: #e67e22; }
        .event-item.garden { background: #16a085; }
        .event-item.house { background: #8e44ad; }
        .event-item.babu { background: #f39c12; }
        .event-item.gcal { background: #4285f4; }

        .sync-icon {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            border: 1px solid white;
            display: none;
        }

        .event-item.synced .sync-icon {
            display: block;
        }

        .daily-schedule {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .schedule-header {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-day-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .sync-day-btn:hover {
            background: #229954;
        }

        .time-slot {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .time-slot:hover {
            background: #f8f9fa;
        }

        .time-label {
            width: 80px;
            font-weight: bold;
            color: #34495e;
            font-size: 1.1em;
        }

        .time-content {
            flex: 1;
            padding-left: 15px;
        }

        .activity {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .activity:hover {
            background: #e8f4fd;
            transform: translateX(5px);
        }

        .activity.fixed {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .activity.flexible {
            border-left-color: #27ae60;
            background: #f2fdf2;
        }

        .activity.gcal {
            border-left-color: #4285f4;
            background: #e8f0fe;
        }

        .sidebar h3 {
            color: #ecf0f1;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .integration-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #34495e;
            border-radius: 10px;
            border: 2px solid #4285f4;
        }

        .integration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .integration-title {
            color: #4285f4;
            font-size: 1.2em;
            font-weight: bold;
        }

        .connection-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #27ae60;
            color: white;
        }

        .connection-status.disconnected {
            background: #e74c3c;
            color: white;
        }

        .connection-status.syncing {
            background: #f39c12;
            color: white;
        }

        .sync-log {
            background: #2c3e50;
            border-radius: 6px;
            padding: 10px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
            color: #bdc3c7;
        }

        .sync-log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid #34495e;
        }

        .sync-log-entry:last-child {
            border-bottom: none;
        }

        .sync-log-entry.success { color: #27ae60; }
        .sync-log-entry.error { color: #e74c3c; }
        .sync-log-entry.info { color: #3498db; }
        .sync-log-entry.warning { color: #f39c12; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ecf0f1;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: #34495e;
            color: white;
            border: 2px solid transparent;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: #2c3e50;
        }

        .form-control::placeholder {
            color: #bdc3c7;
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .form-check input {
            margin-right: 8px;
        }

        .form-check label {
            color: #bdc3c7;
            font-size: 14px;
            margin-bottom: 0;
        }

        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .routine-item {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #f39c12;
        }

        .routine-time {
            font-weight: bold;
            color: #f39c12;
            font-size: 1.1em;
        }

        .routine-task {
            color: #ecf0f1;
            margin-top: 5px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .popup-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s;
        }

        .popup-close:hover {
            color: #e74c3c;
        }

        .popup-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .popup-time {
            font-size: 1.2em;
            color: #3498db;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .popup-description {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .floating-help {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .floating-help:hover {
            transform: scale(1.1);
            background: #2980b9;
        }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container { border-radius: 0; margin: 0; min-height: 100vh; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 1.8em; }
            .sync-status { position: static; justify-content: center; margin-top: 15px; }
            .main-content { grid-template-columns: 1fr; }
            .calendar-section { padding: 15px; order: 1; }
            .sidebar { order: 2; padding: 20px 15px; }
            .floating-help { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗓️ La Mia Agenda Completa</h1>
            <p>Sincronizzazione automatica con Google Calendar</p>
            
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatusText">Inizializzazione...</span>
                <div style="display: flex; gap: 8px;">
                    <button class="sync-btn" onclick="testGoogleAPI()">🔧 Test</button>
                    <button class="sync-btn" onclick="showDomainHelp()" style="background: #e67e22;">🔗 Domini</button>
                    <button class="sync-btn" onclick="resetGoogleAPI()" style="background: #e74c3c;">🔄 Reset</button>
                    <button class="sync-btn" onclick="authenticateUser()" id="authBtn">🔐 Login</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <div style="display: flex; gap: 10px;">
                        <button class="nav-btn" onclick="previousMonth()">←</button>
                        <button class="nav-btn" onclick="nextMonth()">→</button>
                        <button class="nav-btn" onclick="goToToday()">Oggi</button>
                    </div>
                    <div class="current-month" id="currentMonth"></div>
                </div>

                <div class="calendar-grid" id="calendar"></div>

                <div class="daily-schedule">
                    <div class="schedule-header">
                        <span>📅 Programma del <span id="selectedDate"></span></span>
                        <div style="display: flex; gap: 10px;">
                            <button class="sync-day-btn" onclick="syncCurrentDay()">📤 Sync</button>
                            <button class="sync-day-btn" onclick="importCurrentDay()">📥 Import</button>
                        </div>
                    </div>
                    <div id="dailySchedule"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="tasksToday">0</div>
                        <div class="stat-label">Task Oggi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="syncedEvents">0</div>
                        <div class="stat-label">Eventi Sync</div>
                    </div>
                </div>

                <div class="integration-section">
                    <div class="integration-header">
                        <div class="integration-title">📅 Google Calendar</div>
                        <div class="connection-status disconnected" id="connectionStatus">Disconnesso</div>
                    </div>
                    <div class="sync-log" id="syncLog">
                        <div class="sync-log-entry info">Sistema pronto per Google Calendar</div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3>➕ Aggiungi Task</h3>
                    <div class="form-group">
                        <label for="taskTitle">Cosa devi fare?</label>
                        <input type="text" id="taskTitle" class="form-control" placeholder="Es: Appuntamento, Meeting...">
                    </div>
                    <div class="form-group">
                        <label for="taskDate">Data</label>
                        <input type="date" id="taskDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskTime">Orario</label>
                        <input type="time" id="taskTime" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskType">Categoria</label>
                        <select id="taskType" class="form-control">
                            <option value="work">💼 Lavoro</option>
                            <option value="personal">👤 Personale</option>
                            <option value="medical">💊 Cure Annamaria</option>
                            <option value="garden">🌱 Orto/Giardino</option>
                            <option value="house">🏠 Casa</option>
                            <option value="babu">🐕 Babu</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="syncToCalendar" checked>
                        <label for="syncToCalendar">Sincronizza con Google Calendar</label>
                    </div>
                    <button class="btn" onclick="addTask()">Aggiungi Task</button>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3>⏰ Routine Giornaliera</h3>
                    <div class="routine-item">
                        <div class="routine-time">7:00-8:45</div>
                        <div class="routine-task">🐕 Uscita mattutina Babu</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">9:00</div>
                        <div class="routine-task">☕ Colazione + 💊 Medicina Annamaria</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">12:15-13:00</div>
                        <div class="routine-task">🏃 Parco Babu + Ginnastica</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">17:00</div>
                        <div class="routine-task">💊 Medicina Annamaria</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">18:30-20:00</div>
                        <div class="routine-task">🐕 Uscita serale Babu</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">22:30</div>
                        <div class="routine-task">💊 Medicina + 🎮 Tempo libero</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUP DETTAGLI EVENTI -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup()">×</button>
            <div class="popup-title" id="popupTitle"></div>
            <div class="popup-time" id="popupTime"></div>
            <div class="popup-description" id="popupDescription"></div>
        </div>
    </div>

    <button class="floating-help" onclick="showHelp()" title="Aiuto">❓</button>

    <script>
        console.log('🚀 Caricamento WebApp Agenda con Google Calendar...');

        // CONFIGURAZIONE GOOGLE CALENDAR (HARDCODED)
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyBcNSqX0LryFhqzjFWHiq6hMV5S1a9LQfM',
            clientId: '305495314465-j13l2f6scmoqvdadgsnvpskm89g5r6n0.apps.googleusercontent.com',
            calendarId: 'i4fptt554sm1abp0fevv62al4s@group.calendar.google.com',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            scopes: 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events'
        };

        // VARIABILI GLOBALI
        let currentDate = new Date();
        let selectedDate = new Date();
        let tasks = {};
        let currentEvent = null;
        let isGoogleAPILoaded = false;
        let isGISLoaded = false;
        let isGoogleAPIInitialized = false;
        let isUserAuthenticated = false;
        let tokenClient;

        // ROUTINE FISSE
        const fixedRoutine = {
            '07:00': '⏰ Sveglia + 🐕 Uscita Babu',
            '09:00': '☕ Colazione + 💊 Medicina Annamaria',
            '12:15': '🏃 Parco Babu + Ginnastica',
            '13:30': '🍽️ Pranzo',
            '17:00': '💊 Medicina Annamaria',
            '18:30': '🐕 Uscita serale Babu',
            '20:30': '🍽️ Cena',
            '22:30': '💊 Medicina Annamaria + 🎮 Tempo libero'
        };

        const reinaSchedule = {
            1: 'Reina: Bagni + Cucina',
            3: 'Reina: Camere + Biancheria',
            5: 'Reina: Pulizie generali'
        };

        // FUNZIONI UTILITÀ
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForInput(date) {
            return formatDateKey(date);
        }

        function formatDateDisplay(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('it-IT', options);
        }

        function addSyncLog(message, type = 'info') {
            try {
                const container = document.getElementById('syncLog');
                if (container) {
                    const div = document.createElement('div');
                    div.className = `sync-log-entry ${type}`;
                    div.textContent = `[${new Date().toLocaleTimeString('it-IT')}] ${message}`;
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                    
                    if (container.children.length > 6) {
                        container.removeChild(container.firstChild);
                    }
                }
                console.log(`SYNC [${type.toUpperCase()}]:`, message);
            } catch (error) {
                console.log(`SYNC [${type.toUpperCase()}]:`, message);
            }
        }

        // FUNZIONI GOOGLE CALENDAR
        function initGoogleAPI() {
            addSyncLog('Inizializzazione Google Calendar API...', 'info');
            
            if (typeof gapi === 'undefined') {
                addSyncLog('Google API non disponibile. Ricarica la pagina.', 'error');
                updateConnectionStatus('disconnected', 'Google API non disponibile');
                return;
            }

            updateConnectionStatus('syncing', 'Caricamento Google API...');

            gapi.load('client:auth2', {
                callback: function() {
                    addSyncLog('Moduli Google API caricati', 'success');
                    initGoogleClient();
                },
                onerror: function(error) {
                    addSyncLog('Errore caricamento Google API', 'error');
                    updateConnectionStatus('disconnected', 'Errore Google API');
                }
            });
        }

        function initGoogleClient() {
            addSyncLog('Configurazione client Google Calendar...', 'info');
            
            const initConfig = {
                apiKey: GOOGLE_CONFIG.apiKey,
                clientId: GOOGLE_CONFIG.clientId,
                discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
                scope: GOOGLE_CONFIG.scopes
            };

            // Debug della configurazione
            console.log('Configurazione Google:', {
                apiKey: GOOGLE_CONFIG.apiKey ? 'OK' : 'MANCANTE',
                clientId: GOOGLE_CONFIG.clientId ? 'OK' : 'MANCANTE',
                origin: window.location.origin
            });

            gapi.client.init(initConfig).then(
                function() {
                    addSyncLog('Google Calendar API pronta', 'success');
                    isGoogleAPIInitialized = true;
                    
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance) {
                        isUserAuthenticated = authInstance.isSignedIn.get();
                        
                        if (isUserAuthenticated) {
                            addSyncLog('Utente già autenticato', 'success');
                            updateConnectionStatus('connected', 'Google Calendar connesso');
                            loadGoogleCalendarEvents();
                        } else {
                            addSyncLog('Clicca Login per autenticarti', 'info');
                            updateConnectionStatus('disconnected', 'Autenticazione richiesta');
                        }
                        
                        authInstance.isSignedIn.listen(updateSignInStatus);
                    }
                },
                function(error) {
                    addSyncLog('Errore configurazione Google API', 'error');
                    console.error('Dettaglio errore Google API:', error);
                    
                    if (error.error) {
                        switch (error.error) {
                            case 'idpiframe_initialization_failed':
                                addSyncLog('Errore domini autorizzati in Google Cloud Console', 'error');
                                addSyncLog(`Aggiungi ${window.location.origin} alle origini autorizzate`, 'warning');
                                break;
                            case 'invalid_client':
                                addSyncLog('Client ID non valido o non configurato', 'error');
                                break;
                            case 'access_denied':
                                addSyncLog('Accesso negato - controlla le impostazioni OAuth', 'error');
                                break;
                            default:
                                addSyncLog(`Errore: ${error.error}`, 'error');
                        }
                    }
                    
                    updateConnectionStatus('disconnected', 'Errore configurazione');
                }
            );
        }

        function updateSignInStatus(isSignedIn) {
            isUserAuthenticated = isSignedIn;
            if (isSignedIn) {
                addSyncLog('Autenticazione completata', 'success');
                updateConnectionStatus('connected', 'Google Calendar connesso');
                loadGoogleCalendarEvents();
            } else {
                addSyncLog('Utente disconnesso', 'info');
                updateConnectionStatus('disconnected', 'Autenticazione richiesta');
            }
        }

        async function testGoogleAPI() {
            addSyncLog('🔧 Test diagnostico Google API (GIS)...', 'info');
            
            // Test 1: Verifica caricamento gapi
            if (typeof gapi === 'undefined') {
                addSyncLog('❌ Google API non caricata', 'error');
                return;
            }
            addSyncLog('✅ Google API (gapi) caricata', 'success');
            
            // Test 2: Verifica caricamento GIS
            if (typeof google === 'undefined' || !google.accounts) {
                addSyncLog('❌ Google Identity Services non caricata', 'error');
                return;
            }
            addSyncLog('✅ Google Identity Services caricata', 'success');
            
            // Test 3: Debug configurazione
            addSyncLog('🔍 Debug configurazione:', 'info');
            addSyncLog(`• Client ID: ${GOOGLE_CONFIG.clientId.substring(0, 20)}...`, 'info');
            addSyncLog(`• API Key: ${GOOGLE_CONFIG.apiKey.substring(0, 20)}...`, 'info');
            addSyncLog(`• Dominio: ${window.location.origin}`, 'info');
            addSyncLog(`• Protocollo: ${window.location.protocol}`, 'info');
            
            // Test 4: Verifica inizializzazione client
            try {
                addSyncLog('🔄 Test inizializzazione client...', 'info');
                
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    discoveryDocs: GOOGLE_CONFIG.discoveryDocs
                });
                
                addSyncLog('✅ Client API inizializzato', 'success');
                
                // Test token client
                try {
                    const testTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CONFIG.clientId,
                        scope: GOOGLE_CONFIG.scopes,
                        callback: () => {} // callback vuoto per test
                    });
                    
                    addSyncLog('✅ Token client creato con successo', 'success');
                    addSyncLog('🎯 Configurazione corretta! Sistema pronto.', 'success');
                    updateConnectionStatus('disconnected', 'Pronto per login');
                    
                } catch (tokenError) {
                    addSyncLog('❌ Errore token client:', 'error');
                    addSyncLog(tokenError.message, 'error');
                    
                    if (tokenError.message.includes('Invalid origin')) {
                        addSyncLog('🔧 SOLUZIONE - Vai in Google Cloud Console:', 'warning');
                        addSyncLog('1. Credenziali → OAuth 2.0 Client ID', 'warning');
                        addSyncLog('2. Modifica il tuo client', 'warning');
                        addSyncLog(`3. Aggiungi: ${window.location.origin}`, 'warning');
                        addSyncLog('4. Salva e aspetta 5-10 minuti', 'warning');
                    }
                }
                
            } catch (clientError) {
                addSyncLog('❌ Errore inizializzazione client:', 'error');
                addSyncLog(clientError.message, 'error');
                
                if (clientError.message.includes('API key')) {
                    addSyncLog('🔧 Problema API Key - verifica in Google Cloud Console', 'warning');
                } else if (clientError.message.includes('quota')) {
                    addSyncLog('🔧 Quota API superata - controlla limiti', 'warning');
                }
            }
        }

        async function authenticateUser() {
            if (!isGoogleAPIInitialized) {
                addSyncLog('Google API non inizializzata', 'warning');
                initGoogleAPI();
                return;
            }

            try {
                addSyncLog('Avvio autenticazione...', 'info');
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                addSyncLog('Autenticazione riuscita', 'success');
            } catch (error) {
                addSyncLog('Errore autenticazione: ' + error.error, 'error');
                updateConnectionStatus('disconnected', 'Errore autenticazione');
            }
        }

        async function loadGoogleCalendarEvents() {
            if (!isUserAuthenticated) return;

            addSyncLog('Caricamento eventi da Google Calendar...', 'info');
            updateConnectionStatus('syncing', 'Sincronizzazione in corso...');

            try {
                const now = new Date();
                const timeMin = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString();
                const timeMax = new Date(now.getFullYear(), now.getMonth() + 2, 0).toISOString();

                const response = await gapi.client.calendar.events.list({
                    calendarId: GOOGLE_CONFIG.calendarId,
                    timeMin: timeMin,
                    timeMax: timeMax,
                    showDeleted: false,
                    singleEvents: true,
                    orderBy: 'startTime'
                });

                const events = response.result.items || [];
                addSyncLog(`${events.length} eventi caricati da Google Calendar`, 'success');

                // Integra eventi Google Calendar nei task locali
                events.forEach(event => {
                    const startDate = event.start.dateTime || event.start.date;
                    const eventDate = new Date(startDate);
                    const dateKey = formatDateKey(eventDate);
                    
                    if (!tasks[dateKey]) {
                        tasks[dateKey] = [];
                    }

                    // Controlla se l'evento esiste già
                    const existingEvent = tasks[dateKey].find(task => task.googleEventId === event.id);
                    if (!existingEvent) {
                        const eventTime = event.start.dateTime ? 
                            new Date(event.start.dateTime).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}) : 
                            '';

                        tasks[dateKey].push({
                            title: event.summary || 'Evento Google',
                            time: eventTime,
                            type: 'gcal',
                            id: 'gcal_' + event.id,
                            googleEventId: event.id,
                            description: event.description || 'Evento da Google Calendar',
                            synced: true,
                            source: 'google_calendar'
                        });
                    }
                });

                // Ordina gli eventi per orario
                Object.keys(tasks).forEach(dateKey => {
                    tasks[dateKey].sort((a, b) => {
                        if (!a.time && !b.time) return 0;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });
                });

                updateConnectionStatus('connected', 'Sincronizzazione completata');
                updateDisplay();
                updateStats();

            } catch (error) {
                addSyncLog('Errore caricamento eventi: ' + error.message, 'error');
                updateConnectionStatus('connected', 'Errore caricamento eventi');
            }
        }

        async function syncTaskToGoogle(task, dateKey) {
            if (!isUserAuthenticated || !task.syncToCalendar) return false;

            try {
                const taskDate = new Date(dateKey + 'T00:00:00');
                let startDateTime, endDateTime;

                if (task.time) {
                    const [hours, minutes] = task.time.split(':');
                    startDateTime = new Date(taskDate);
                    startDateTime.setHours(parseInt(hours), parseInt(minutes));
                    endDateTime = new Date(startDateTime);
                    endDateTime.setHours(startDateTime.getHours() + 1);
                } else {
                    startDateTime = taskDate;
                    endDateTime = new Date(taskDate);
                    endDateTime.setDate(endDateTime.getDate() + 1);
                }

                const event = {
                    summary: task.title,
                    description: task.description || 'Evento creato da Agenda Personale',
                    start: task.time ? 
                        { dateTime: startDateTime.toISOString() } : 
                        { date: startDateTime.toISOString().split('T')[0] },
                    end: task.time ? 
                        { dateTime: endDateTime.toISOString() } : 
                        { date: endDateTime.toISOString().split('T')[0] }
                };

                const response = await gapi.client.calendar.events.insert({
                    calendarId: GOOGLE_CONFIG.calendarId,
                    resource: event
                });

                if (response.result) {
                    task.synced = true;
                    task.googleEventId = response.result.id;
                    addSyncLog(`Task "${task.title}" sincronizzato con Google Calendar`, 'success');
                    return true;
                }

            } catch (error) {
                addSyncLog(`Errore sincronizzazione "${task.title}": ${error.message}`, 'error');
                return false;
            }
        }

        async function syncCurrentDay() {
            if (!isUserAuthenticated) {
                addSyncLog('Devi autenticarti prima di sincronizzare', 'warning');
                return;
            }

            const dateKey = formatDateKey(selectedDate);
            const dayTasks = tasks[dateKey] || [];
            const unsyncedTasks = dayTasks.filter(task => !task.synced && task.source !== 'google_calendar');

            if (unsyncedTasks.length === 0) {
                addSyncLog('Nessun task da sincronizzare per questo giorno', 'info');
                return;
            }

            addSyncLog(`Sincronizzazione di ${unsyncedTasks.length} task...`, 'info');
            updateConnectionStatus('syncing', 'Sincronizzazione in corso...');

            let syncedCount = 0;
            for (const task of unsyncedTasks) {
                if (await syncTaskToGoogle(task, dateKey)) {
                    syncedCount++;
                }
            }

            addSyncLog(`${syncedCount}/${unsyncedTasks.length} task sincronizzati`, 'success');
            updateConnectionStatus('connected', 'Sincronizzazione completata');
            updateDisplay();
            updateStats();
        }

        async function importCurrentDay() {
            if (!isUserAuthenticated) {
                addSyncLog('Devi autenticarti prima di importare', 'warning');
                return;
            }

            addSyncLog('Importazione eventi del giorno...', 'info');
            await loadGoogleCalendarEvents();
        }

        function updateConnectionStatus(status, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            const syncIndicator = document.getElementById('syncIndicator');
            const syncStatusText = document.getElementById('syncStatusText');
            const authBtn = document.getElementById('authBtn');
            
            if (statusElement) {
                statusElement.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusElement.textContent = 'Connesso';
                        syncStatusText.textContent = 'Google Calendar Connesso';
                        syncIndicator.className = 'sync-indicator connected';
                        authBtn.textContent = '✅ Connesso';
                        authBtn.disabled = true;
                        break;
                    case 'disconnected':
                        statusElement.textContent = 'Disconnesso';
                        syncStatusText.textContent = 'Non connesso';
                        syncIndicator.className = 'sync-indicator';
                        authBtn.textContent = '🔐 Login';
                        authBtn.disabled = false;
                        break;
                    case 'syncing':
                        statusElement.textContent = 'Sincronizzazione...';
                        syncStatusText.textContent = 'Sincronizzazione...';
                        syncIndicator.className = 'sync-indicator syncing';
                        break;
                }
            }
            
            if (message) {
                addSyncLog(message, status === 'connected' ? 'success' : status === 'error' ? 'error' : 'info');
            }
        }

        // CARICAMENTO DATI RACCOLTA DIFFERENZIATA
        function initDemoTasks() {
            console.log('🔄 Caricamento calendario raccolta differenziata 2025...');
            
            tasks = {};
            
            // RACCOLTA DIFFERENZIATA 2025 - CALENDARIO COMPLETO
            const wasteData = [
                '2025-01-02,VETRO','2025-01-03,CARTA','2025-01-05,PLASTICA E METALLI / PANNOLINI',
                '2025-01-07,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-01-09,VETRO','2025-01-10,ORGANICO / PANNOLINI',
                '2025-01-12,PLASTICA E METALLI / PANNOLINI','2025-01-14,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-01-16,CARTA','2025-01-17,ORGANICO / PANNOLINI','2025-01-19,PLASTICA E METALLI / PANNOLINI',
                '2025-01-21,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-01-23,VETRO','2025-01-24,ORGANICO / PANNOLINI',
                '2025-01-26,PLASTICA E METALLI / PANNOLINI','2025-01-28,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-01-30,CARTA','2025-01-31,ORGANICO / PANNOLINI',
                '2025-02-02,PLASTICA E METALLI / PANNOLINI','2025-02-04,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-02-06,VETRO','2025-02-07,ORGANICO / PANNOLINI','2025-02-09,PLASTICA E METALLI / PANNOLINI',
                '2025-02-11,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-02-13,CARTA','2025-02-14,ORGANICO / PANNOLINI',
                '2025-02-16,PLASTICA E METALLI / PANNOLINI','2025-02-18,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-02-20,VETRO','2025-02-21,ORGANICO / PANNOLINI','2025-02-23,PLASTICA E METALLI / PANNOLINI',
                '2025-02-25,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-02-27,CARTA','2025-02-28,ORGANICO / PANNOLINI',
                '2025-03-02,PLASTICA E METALLI / PANNOLINI','2025-03-04,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-03-06,VETRO','2025-03-07,ORGANICO / PANNOLINI','2025-03-09,PLASTICA E METALLI / PANNOLINI',
                '2025-03-11,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-03-13,CARTA','2025-03-14,ORGANICO / PANNOLINI',
                '2025-03-16,PLASTICA E METALLI / PANNOLINI','2025-03-18,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-03-20,VETRO','2025-03-21,ORGANICO / PANNOLINI','2025-03-23,PLASTICA E METALLI / PANNOLINI',
                '2025-03-25,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-03-27,CARTA','2025-03-28,ORGANICO / PANNOLINI',
                '2025-03-30,PLASTICA E METALLI / PANNOLINI','2025-04-01,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-04-03,VETRO','2025-04-04,ORGANICO / PANNOLINI','2025-04-06,PLASTICA E METALLI / PANNOLINI',
                '2025-04-08,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-04-10,CARTA','2025-04-11,ORGANICO / PANNOLINI',
                '2025-04-13,PLASTICA E METALLI / PANNOLINI','2025-04-15,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-04-17,VETRO','2025-04-18,ORGANICO / PANNOLINI','2025-04-20,PLASTICA E METALLI / PANNOLINI',
                '2025-04-22,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-04-24,CARTA','2025-04-25,ORGANICO / PANNOLINI',
                '2025-04-27,PLASTICA E METALLI / PANNOLINI','2025-04-29,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-05-01,VETRO','2025-05-02,ORGANICO / PANNOLINI','2025-05-04,PLASTICA E METALLI / PANNOLINI',
                '2025-05-06,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-05-08,CARTA','2025-05-09,ORGANICO / PANNOLINI',
                '2025-05-11,PLASTICA E METALLI / PANNOLINI','2025-05-12,ORGANICO','2025-05-13,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-05-14,ORGANICO','2025-05-15,VETRO','2025-05-16,ORGANICO / PANNOLINI',
                '2025-05-18,PLASTICA E METALLI / PANNOLINI','2025-05-19,ORGANICO','2025-05-20,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-05-21,ORGANICO','2025-05-22,CARTA','2025-05-23,ORGANICO / PANNOLINI',
                '2025-05-25,PLASTICA E METALLI / PANNOLINI','2025-05-26,ORGANICO','2025-05-27,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-05-28,ORGANICO','2025-05-29,VETRO','2025-05-30,ORGANICO / PANNOLINI',
                '2025-06-01,PLASTICA E METALLI / PANNOLINI','2025-06-02,ORGANICO','2025-06-03,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-06-04,ORGANICO','2025-06-05,CARTA','2025-06-06,ORGANICO / PANNOLINI',
                '2025-06-08,PLASTICA E METALLI / PANNOLINI','2025-06-09,ORGANICO','2025-06-10,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-06-11,ORGANICO','2025-06-12,VETRO','2025-06-13,ORGANICO / PANNOLINI',
                '2025-06-15,PLASTICA E METALLI / PANNOLINI','2025-06-16,ORGANICO','2025-06-17,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-06-18,ORGANICO','2025-06-19,CARTA','2025-06-20,ORGANICO / PANNOLINI',
                '2025-06-22,PLASTICA E METALLI / PANNOLINI','2025-06-23,ORGANICO','2025-06-24,RESIDUO NON RICICLABILE / PANNOLINI',
                '2025-06-25,ORGANICO','2025-06-26,VETRO','2025-06-27,ORGANICO / PANNOLINI',
                '2025-06-29,PLASTICA E METALLI / PANNOLINI','2025-06-30,ORGANICO',
                '2025-07-01,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-02,ORGANICO','2025-07-03,CARTA',
                '2025-07-04,ORGANICO / PANNOLINI','2025-07-06,PLASTICA E METALLI / PANNOLINI','2025-07-07,ORGANICO',
                '2025-07-08,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-09,ORGANICO','2025-07-10,VETRO',
                '2025-07-11,ORGANICO / PANNOLINI','2025-07-13,PLASTICA E METALLI / PANNOLINI','2025-07-14,ORGANICO',
                '2025-07-15,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-16,ORGANICO','2025-07-17,CARTA',
                '2025-07-18,ORGANICO / PANNOLINI','2025-07-20,PLASTICA E METALLI / PANNOLINI','2025-07-21,ORGANICO',
                '2025-07-22,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-23,ORGANICO','2025-07-24,VETRO',
                '2025-07-25,ORGANICO / PANNOLINI','2025-07-27,PLASTICA E METALLI / PANNOLINI','2025-07-28,ORGANICO',
                '2025-07-29,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-30,ORGANICO','2025-07-31,CARTA',
                '2025-08-01,ORGANICO / PANNOLINI','2025-08-03,PLASTICA E METALLI / PANNOLINI','2025-08-04,ORGANICO',
                '2025-08-05,RESIDUO NON RICICLABILE / PANNOLINI','2025-08-06,ORGANICO','2025-08-07,VETRO',
                '2025-08-08,ORGANICO / PANNOLINI','2025-08-10,PLASTICA E METALLI / PANNOLINI','2025-08-11,ORGANICO',
                '2025-08-12,RESIDUO NON RICICLABILE / PANNOLINI','2025-08-13,ORGANICO','2025-08-14,CARTA',
                '2025-08-15,ORGANICO / PANNOLINI','2025-08-17,PLASTICA E METALLI / PANNOLINI','2025-08-18,ORGANICO',
                '2025-08-19,RESIDUO NON RICICLABILE / PANNOLINI','2025-08-20,ORGANICO','2025-08-21,VETRO',
                '2025-08-22,ORGANICO / PANNOLINI','2025-08-24,PLASTICA E METALLI / PANNOLINI','2025-08-25,ORGANICO',
                '2025-08-26,RESIDUO NON RICICLABILE / PANNOLINI','2025-08-27,ORGANICO','2025-08-28,CARTA',
                '2025-08-29,ORGANICO / PANNOLINI','2025-08-31,PLASTICA E METALLI / PANNOLINI',
                '2025-09-01,ORGANICO','2025-09-02,RESIDUO NON RICICLABILE / PANNOLINI','2025-09-03,ORGANICO',
                '2025-09-04,VETRO','2025-09-05,ORGANICO / PANNOLINI','2025-09-07,PLASTICA E METALLI / PANNOLINI',
                '2025-09-08,ORGANICO','2025-09-09,RESIDUO NON RICICLABILE / PANNOLINI','2025-09-10,ORGANICO',
                '2025-09-11,CARTA','2025-09-12,ORGANICO / PANNOLINI','2025-09-14,PLASTICA E METALLI / PANNOLINI',
                '2025-09-16,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-09-18,VETRO','2025-09-19,ORGANICO / PANNOLINI',
                '2025-09-21,PLASTICA E METALLI / PANNOLINI','2025-09-23,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-09-25,CARTA','2025-09-26,ORGANICO / PANNOLINI','2025-09-28,PLASTICA E METALLI / PANNOLINI',
                '2025-09-30,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-10-02,VETRO','2025-10-03,ORGANICO / PANNOLINI',
                '2025-10-05,PLASTICA E METALLI / PANNOLINI','2025-10-07,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-10-09,CARTA','2025-10-10,ORGANICO / PANNOLINI','2025-10-12,PLASTICA E METALLI / PANNOLINI',
                '2025-10-14,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-10-16,VETRO','2025-10-17,ORGANICO / PANNOLINI',
                '2025-10-19,PLASTICA E METALLI / PANNOLINI','2025-10-21,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-10-23,CARTA','2025-10-24,ORGANICO / PANNOLINI','2025-10-26,PLASTICA E METALLI / PANNOLINI',
                '2025-10-28,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-10-30,VETRO','2025-10-31,ORGANICO / PANNOLINI',
                '2025-11-02,PLASTICA E METALLI / PANNOLINI','2025-11-04,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-11-06,CARTA','2025-11-07,ORGANICO / PANNOLINI','2025-11-09,PLASTICA E METALLI / PANNOLINI',
                '2025-11-11,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-11-13,VETRO','2025-11-14,ORGANICO / PANNOLINI',
                '2025-11-16,PLASTICA E METALLI / PANNOLINI','2025-11-18,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-11-20,CARTA','2025-11-21,ORGANICO / PANNOLINI','2025-11-23,PLASTICA E METALLI / PANNOLINI',
                '2025-11-25,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-11-27,VETRO','2025-11-28,ORGANICO / PANNOLINI',
                '2025-11-30,PLASTICA E METALLI / PANNOLINI','2025-12-02,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-12-04,CARTA','2025-12-05,ORGANICO / PANNOLINI','2025-12-07,PLASTICA E METALLI / PANNOLINI',
                '2025-12-09,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-12-11,VETRO','2025-12-12,ORGANICO / PANNOLINI',
                '2025-12-14,PLASTICA E METALLI / PANNOLINI','2025-12-16,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO',
                '2025-12-18,CARTA','2025-12-19,ORGANICO / PANNOLINI','2025-12-21,PLASTICA E METALLI / PANNOLINI',
                '2025-12-23,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO','2025-12-25,VETRO','2025-12-26,ORGANICO / PANNOLINI',
                '2025-12-28,PLASTICA E METALLI / PANNOLINI','2025-12-30,RESIDUO NON RICICLABILE / PANNOLINI / ORGANICO'
            ];

            function getWasteEmoji(wasteType) {
                if (wasteType.includes('VETRO')) return '🥛';
                if (wasteType.includes('ORGANICO')) return '🍃';
                if (wasteType.includes('PLASTICA')) return '♻️';
                if (wasteType.includes('CARTA')) return '📄';
                if (wasteType.includes('RESIDUO')) return '🗑️';
                return '🗑️';
            }

            let loadedTasks = 0;
            wasteData.forEach(function(item) {
                const parts = item.split(',');
                const dateKey = parts[0];
                const wasteType = parts[1];
                
                if (!tasks[dateKey]) {
                    tasks[dateKey] = [];
                }
                
                const emoji = getWasteEmoji(wasteType);
                tasks[dateKey].push({
                    title: emoji + ' ' + wasteType,
                    time: '21:00',
                    type: 'house',
                    id: 'waste_' + dateKey,
                    description: 'Raccolta differenziata - Esporre dopo le 21:00',
                    synced: false,
                    syncToCalendar: false,
                    source: 'local'
                });
                
                loadedTasks++;
            });

            console.log('✅ Calendario raccolta differenziata caricato');
            console.log('📊 Totale giorni con raccolta:', loadedTasks);
        }

        // FUNZIONI CALENDARIO
        function updateDisplay() {
            updateCalendarDisplay();
            updateDailySchedule();
        }

        function updateCalendarDisplay() {
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
                "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            
            const monthDisplay = document.getElementById('currentMonth');
            if (monthDisplay) {
                monthDisplay.textContent = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            }

            generateCalendar();
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            if (!calendar) return;
            
            calendar.innerHTML = '';

            const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            dayNames.forEach(function(day) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startingDayOfWeek = (firstDay.getDay() + 6) % 7;

            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = new Date(firstDay);
                day.setDate(day.getDate() - i - 1);
                createDayElement(day, true);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                createDayElement(date, false);
            }

            const remainingCells = 42 - (startingDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, day);
                createDayElement(date, true);
            }
        }

        function createDayElement(date, isOtherMonth) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            if (isOtherMonth) dayElement.classList.add('other-month');
            
            const dateKey = formatDateKey(date);
            const selectedDateKey = formatDateKey(selectedDate);
            const todayKey = formatDateKey(new Date());
            
            if (dateKey === selectedDateKey) {
                dayElement.classList.add('selected');
            }
            
            if (dateKey === todayKey && !isOtherMonth) {
                dayElement.classList.add('today');
            }

            dayElement.innerHTML = '<div class="day-number">' + date.getDate() + '</div>' +
                                   '<div class="day-events" id="events-' + dateKey + '"></div>';

            dayElement.onclick = function() { selectDate(date); };
            document.getElementById('calendar').appendChild(dayElement);

            updateDayEvents(date, dateKey);
        }

        function updateDayEvents(date, dateKey) {
            const eventsContainer = document.getElementById('events-' + dateKey);
            if (!eventsContainer) return;

            eventsContainer.innerHTML = '';
            const dayOfWeek = date.getDay();
            
            // EVENTI ROUTINE REINA (Lunedì, Mercoledì, Venerdì)
            if ([1, 3, 5].includes(dayOfWeek)) {
                const reinaEvent = document.createElement('div');
                reinaEvent.className = 'event-item personal';
                reinaEvent.innerHTML = 'Reina<div class="sync-icon"></div>';
                reinaEvent.onclick = function(e) {
                    e.stopPropagation();
                    showPopup({
                        title: reinaSchedule[dayOfWeek],
                        time: '09:00',
                        type: 'personal',
                        description: 'Pulizie domestiche con Reina',
                        synced: false
                    });
                };
                eventsContainer.appendChild(reinaEvent);
            }

            // CALL SETTIMANALE (solo Lunedì)
            if (dayOfWeek === 1) {
                const callEvent = document.createElement('div');
                callEvent.className = 'event-item work';
                callEvent.innerHTML = 'Call<div class="sync-icon"></div>';
                callEvent.onclick = function(e) {
                    e.stopPropagation();
                    showPopup({
                        title: 'Call Reaplace.it',
                        time: '18:00',
                        type: 'work',
                        description: 'Chiamata settimanale fissa con il cliente',
                        synced: false
                    });
                };
                eventsContainer.appendChild(callEvent);
            }

            // TASK PROGRAMMATI
            if (tasks[dateKey] && Array.isArray(tasks[dateKey])) {
                tasks[dateKey].forEach(function(task) {
                    const taskEvent = document.createElement('div');
                    let eventClass = 'event-item ' + task.type;
                    
                    if (task.source === 'google_calendar') {
                        eventClass += ' gcal';
                    }
                    if (task.synced) {
                        eventClass += ' synced';
                    }
                    taskEvent.className = eventClass;
                    
                    let displayText = task.title;
                    if (task.time) {
                        displayText = task.time + ' ' + displayText;
                    }
                    
                    taskEvent.innerHTML = displayText + '<div class="sync-icon"></div>';
                    taskEvent.onclick = function(e) {
                        e.stopPropagation();
                        showPopup(task);
                    };
                    eventsContainer.appendChild(taskEvent);
                });
            }
        }

        function selectDate(date) {
            document.querySelectorAll('.calendar-day.selected').forEach(function(day) {
                day.classList.remove('selected');
            });

            selectedDate = new Date(date);
            
            const dayElements = document.querySelectorAll('.calendar-day');
            dayElements.forEach(function(day) {
                const dayNumber = day.querySelector('.day-number');
                if (dayNumber && parseInt(dayNumber.textContent) === date.getDate()) {
                    day.classList.add('selected');
                }
            });

            updateDailySchedule();
            document.getElementById('taskDate').value = formatDateForInput(selectedDate);
        }

        function updateDailySchedule() {
            const schedule = document.getElementById('dailySchedule');
            const dateDisplay = document.getElementById('selectedDate');
            
            if (!schedule || !dateDisplay) return;
            
            const dateStr = formatDateDisplay(selectedDate);
            dateDisplay.textContent = dateStr;

            const dayOfWeek = selectedDate.getDay();
            const dateKey = formatDateKey(selectedDate);
            let scheduleHTML = '';

            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = hour.toString().padStart(2, '0') + ':00';
                let activities = [];

                // ROUTINE FISSE GIORNALIERE
                if (fixedRoutine[timeSlot]) {
                    activities.push({
                        text: fixedRoutine[timeSlot],
                        type: 'fixed',
                        time: timeSlot,
                        synced: false
                    });
                }

                // EVENTI REINA (Lunedì, Mercoledì, Venerdì alle 9:00)
                if ([1, 3, 5].includes(dayOfWeek) && hour === 9) {
                    activities.push({
                        text: reinaSchedule[dayOfWeek],
                        type: 'fixed',
                        time: timeSlot,
                        synced: false
                    });
                }

                // CALL SETTIMANALE (Lunedì alle 18:00)
                if (dayOfWeek === 1 && timeSlot === '18:00') {
                    activities.push({
                        text: '📞 Call Reaplace.it',
                        type: 'fixed',
                        time: timeSlot,
                        synced: false
                    });
                }

                // TASK PROGRAMMATI
                if (tasks[dateKey] && Array.isArray(tasks[dateKey])) {
                    tasks[dateKey].forEach(function(task) {
                        if (task.time && task.time.startsWith(timeSlot.substring(0, 2))) {
                            let activityType = 'flexible';
                            if (task.source === 'google_calendar') {
                                activityType = 'gcal';
                            }
                            activities.push({
                                text: task.title,
                                type: activityType,
                                time: task.time,
                                taskData: task,
                                synced: task.synced
                            });
                        }
                    });
                }

                if (activities.length > 0) {
                    scheduleHTML += '<div class="time-slot">' +
                        '<div class="time-label">' + timeSlot + '</div>' +
                        '<div class="time-content">';
                    
                    activities.forEach(function(activity) {
                        const syncIcon = activity.synced ? '<div class="sync-icon"></div>' : '';
                        scheduleHTML += '<div class="activity ' + activity.type + '" onclick="showPopup(' + 
                            JSON.stringify(activity.taskData || {
                                title: activity.text, 
                                time: activity.time, 
                                type: activity.type,
                                synced: activity.synced,
                                description: activity.text
                            }).replace(/"/g, '&quot;') + 
                            ')">' + activity.text + syncIcon + '</div>';
                    });
                    
                    scheduleHTML += '</div></div>';
                }
            }

            schedule.innerHTML = scheduleHTML || '<p>Nessuna attività programmata per questo giorno.</p>';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendarDisplay();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendarDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            selectedDate = new Date();
            updateDisplay();
            addSyncLog('Tornato a oggi: ' + formatDateDisplay(new Date()), 'info');
        }

        function showPopup(event) {
            currentEvent = event;
            document.getElementById('popupTitle').textContent = event.title;
            document.getElementById('popupTime').textContent = event.time ? '🕐 ' + event.time : '';
            
            let description = '';
            if (event.description) {
                description = event.description;
            } else {
                description = event.title || 'Attività programmata';
            }
            
            if (event.synced) {
                description += '\n\n✅ Sincronizzato con Google Calendar';
            }
            if (event.source === 'google_calendar') {
                description += '\n\n📅 Importato da Google Calendar';
            }
            
            document.getElementById('popupDescription').textContent = description;
            document.getElementById('popupOverlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
            currentEvent = null;
        }

        function showDomainHelp() {
            const helpText = `🔗 CONFIGURAZIONE DOMINI GOOGLE CLOUD CONSOLE

📍 DOMINIO DA AGGIUNGERE (SOLO QUESTO):
• https://franzvac.github.io

❌ NON aggiungere percorsi completi come:
• https://franzvac.github.io/agenda-calendar/ 

🛠️ PROCEDURA CORRETTA:

1️⃣ Vai su console.cloud.google.com
2️⃣ Seleziona il tuo progetto
3️⃣ Menu → API e servizi → Credenziali
4️⃣ Clicca sul tuo OAuth 2.0 Client ID
5️⃣ Nella sezione "Origini JavaScript autorizzate"
6️⃣ Assicurati che ci sia SOLO: https://franzvac.github.io
7️⃣ Rimuovi eventuali altri domini di GitHub
8️⃣ Clicca "SALVA"

⏰ Aspetta 5-10 minuti dopo aver salvato!

🔧 RESET COMPLETO:
Se continua a non funzionare, prova a ricaricare la pagina completamente (Ctrl+F5).

🔍 INFO DEBUG:
• URL corrente: ${window.location.href}
• Origin: ${window.location.origin}
• Client ID: ${GOOGLE_CONFIG.clientId.substring(0, 20)}...`;

            alert(helpText);
            
            addSyncLog('📋 Guida domini aggiornata mostrata', 'info');
            addSyncLog(`🔍 Usa SOLO questo dominio: ${window.location.origin}`, 'warning');
        }

        function resetGoogleAPI() {
            addSyncLog('🔄 Reset completo Google API...', 'warning');
            
            // Reset variabili
            isGoogleAPILoaded = false;
            isGISLoaded = false;
            isGoogleAPIInitialized = false;
            isUserAuthenticated = false;
            tokenClient = null;
            
            // Reset token se presente
            if (typeof gapi !== 'undefined' && gapi.client && gapi.client.getToken) {
                gapi.client.setToken(null);
            }
            
            updateConnectionStatus('disconnected', 'Reset completato');
            addSyncLog('✅ Reset completato - Reinizializzazione...', 'success');
            
            setTimeout(() => {
                initGoogleAPI();
            }, 1000);
        }

        function showHelp() {
            const helpText = `🎯 AGENDA CON GOOGLE CALENDAR

📅 FUNZIONI PRINCIPALI:
• Calendario navigabile con eventi
• Sincronizzazione automatica Google Calendar
• Gestione task con categorizzazione
• Routine giornaliere automatiche
• Raccolta differenziata 2025

🔐 AUTENTICAZIONE:
• Clicca "Login" per connetterti a Google
• Permetti l'accesso al tuo calendario
• Sincronizzazione automatica

🔄 SINCRONIZZAZIONE:
• "Sync": carica eventi locali su Google
• "Import": scarica eventi da Google Calendar
• Checkbox per auto-sync nuovi task

📊 DATI INCLUSI:
• 365 giorni raccolta differenziata 2025
• Routine giornaliere (medicina, uscite Babu)
• Eventi settimanali (Reina, call clienti)
• Eventi Google Calendar integrati`;

            alert(helpText);
        }

        // GESTIONE TASK
        function addTask() {
            try {
                const title = document.getElementById('taskTitle').value.trim();
                const dateInput = document.getElementById('taskDate').value;
                const time = document.getElementById('taskTime').value;
                const type = document.getElementById('taskType').value;
                const syncToCalendar = document.getElementById('syncToCalendar').checked;

                if (!title || !dateInput) {
                    alert('Inserisci almeno il titolo e la data del task!');
                    return;
                }

                const dateKey = dateInput;

                if (!tasks[dateKey]) {
                    tasks[dateKey] = [];
                }

                const newTask = {
                    title: title,
                    time: time,
                    type: type,
                    id: Date.now(),
                    synced: false,
                    syncToCalendar: syncToCalendar,
                    source: 'local'
                };

                tasks[dateKey].push(newTask);

                // Ordina i task per orario
                tasks[dateKey].sort(function(a, b) {
                    if (!a.time && !b.time) return 0;
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });

                // Sincronizza automaticamente se richiesto e utente autenticato
                if (syncToCalendar && isUserAuthenticated) {
                    syncTaskToGoogle(newTask, dateKey);
                }

                document.getElementById('taskTitle').value = '';
                document.getElementById('taskTime').value = '';

                updateDisplay();
                updateStats();

                const taskDate = new Date(dateInput + 'T00:00:00');
                const formattedDate = taskDate.toLocaleDateString('it-IT');
                const timeText = time ? `alle ${time}` : 'senza orario specifico';
                addSyncLog(`Task "${title}" aggiunto per ${formattedDate} ${timeText}`, 'success');
                
            } catch (error) {
                console.error('Errore addTask:', error);
                addSyncLog('Errore aggiunta task', 'error');
            }
        }

        function updateStats() {
            const today = formatDateKey(new Date());
            const todayTasks = (tasks[today] && Array.isArray(tasks[today])) ? tasks[today].length : 0;
            
            const tasksElement = document.getElementById('tasksToday');
            if (tasksElement) {
                tasksElement.textContent = todayTasks;
            }
            
            // Conta eventi sincronizzati
            let syncedCount = 0;
            Object.values(tasks).forEach(function(dayTasks) {
                if (Array.isArray(dayTasks)) {
                    dayTasks.forEach(function(task) {
                        if (task.synced) syncedCount++;
                    });
                }
            });
            
            const syncedElement = document.getElementById('syncedEvents');
            if (syncedElement) {
                syncedElement.textContent = syncedCount;
            }
        }

        function initCalendar() {
            console.log('🔄 Inizializzazione calendario...');
            
            updateDisplay();
            
            const taskDateField = document.getElementById('taskDate');
            if (taskDateField) {
                taskDateField.value = formatDateForInput(selectedDate);
            }
            
            updateStats();
            
            console.log('✅ Calendario inizializzato');
        }

        // EVENT LISTENERS E INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INIZIALIZZAZIONE WEBAPP GOOGLE CALENDAR ===');
            
            try {
                initDemoTasks();
                initCalendar();
                
                // Inizializza SOLO se librerie non sono già caricate
                addSyncLog('🔍 Controllo stato librerie moderne...', 'info');
                
                const gapiOK = typeof gapi !== 'undefined';
                const gisOK = typeof google !== 'undefined' && google.accounts;
                
                if (gapiOK && gisOK) {
                    addSyncLog('✅ Librerie già disponibili - Configurazione moderna', 'success');
                    isGoogleAPILoaded = true;
                    isGISLoaded = true;
                    setTimeout(() => initModernGoogleAPI(), 500);
                } else {
                    addSyncLog('⏳ Attendo caricamento librerie...', 'info');
                    addSyncLog(`GAPI: ${gapiOK ? '✅' : '❌'}, GIS: ${gisOK ? '✅' : '❌'}`, 'info');
                }

                // Aggiungi diagnostica per debug
                setTimeout(() => {
                    addSyncLog(`🔍 Dominio corrente: ${window.location.origin}`, 'info');
                    addSyncLog('📋 Verifica in Google Cloud Console:', 'info');
                    addSyncLog('• OAuth 2.0 Client ID configurato', 'info');
                    addSyncLog('• Origini JavaScript autorizzate incluso questo dominio', 'info');
                    addSyncLog('• Calendar API abilitata nel progetto', 'info');
                }, 2000);
                
                console.log('✅ WebApp inizializzata con successo');
                
                // Event listeners per popup
                const popupOverlay = document.getElementById('popupOverlay');
                if (popupOverlay) {
                    popupOverlay.addEventListener('click', function(e) {
                        if (e.target === this) closePopup();
                    });
                }
                
                // Event listeners per input
                const taskTitle = document.getElementById('taskTitle');
                if (taskTitle) {
                    taskTitle.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') addTask();
                    });
                }
                
                // Messaggio di benvenuto
                setTimeout(function() {
                    const today = formatDateDisplay(new Date());
                    const todayKey = formatDateKey(new Date());
                    
                    addSyncLog(`🎯 AGENDA GOOGLE CALENDAR - ${today}`, 'success');
                    addSyncLog('📋 Sistema inizializzato correttamente', 'info');
                    addSyncLog('🗑️ Calendario raccolta differenziata 2025 caricato', 'success');
                    
                    // Controlla se oggi c'è raccolta rifiuti
                    const todayTasks = tasks[todayKey] || [];
                    const wasteToday = todayTasks.find(function(task) {
                        return task.title.includes('CARTA') || 
                               task.title.includes('VETRO') || 
                               task.title.includes('PLASTICA') || 
                               task.title.includes('ORGANICO') || 
                               task.title.includes('RESIDUO');
                    });
                    
                    if (wasteToday) {
                        addSyncLog(`📅 OGGI: ${wasteToday.title} alle ${wasteToday.time}`, 'info');
                    }
                    
                    // Mostra statistiche caricate
                    const totalDays = Object.keys(tasks).length;
                    if (totalDays > 0) {
                        addSyncLog(`📊 ${totalDays} giorni con eventi programmati`, 'success');
                    }
                    
                    addSyncLog('🔧 Clicca "Test" per verificare Google API', 'info');
                    addSyncLog('🔐 Poi clicca "Login" per connettere Google Calendar', 'info');
                }, 1500);
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                addSyncLog('❌ Errore durante inizializzazione', 'error');
            }
        });

        // Gestione caricamento Google API e GIS - SOLO MODERNA
        window.gapiLoaded = function() {
            addSyncLog('✅ Google API (gapi) caricata', 'success');
            isGoogleAPILoaded = true;
            checkAndInitialize();
        };

        window.gisLoaded = function() {
            addSyncLog('✅ Google Identity Services caricata', 'success');
            isGISLoaded = true;
            checkAndInitialize();
        };

        function checkAndInitialize() {
            if (isGoogleAPILoaded && isGISLoaded) {
                addSyncLog('🚀 Tutte le librerie moderne caricate', 'success');
                setTimeout(() => {
                    // SOLO inizializzazione moderna
                    initModernGoogleAPI();
                }, 500);
            }
        }

        // NUOVA funzione di inizializzazione - SOLO GIS
        function initModernGoogleAPI() {
            addSyncLog('🆕 Inizializzazione Google API moderna (GIS only)...', 'info');
            updateConnectionStatus('syncing', 'Inizializzazione moderna...');

            // Inizializza SOLO il client API (NO auth2)
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_CONFIG.apiKey,
                        discoveryDocs: GOOGLE_CONFIG.discoveryDocs
                    });

                    addSyncLog('✅ Client API moderno inizializzato', 'success');

                    // Crea token client moderno
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CONFIG.clientId,
                        scope: GOOGLE_CONFIG.scopes,
                        callback: (response) => {
                            if (response.error) {
                                addSyncLog('❌ Errore OAuth: ' + response.error, 'error');
                                updateConnectionStatus('disconnected', 'Errore autenticazione');
                                return;
                            }
                            
                            addSyncLog('✅ Token OAuth ricevuto', 'success');
                            isUserAuthenticated = true;
                            updateConnectionStatus('connected', 'Connesso via GIS');
                            
                            gapi.client.setToken({
                                access_token: response.access_token
                            });
                            
                            loadGoogleCalendarEvents();
                        }
                    });

                    addSyncLog('✅ Sistema moderno configurato', 'success');
                    isGoogleAPIInitialized = true;
                    updateConnectionStatus('disconnected', 'Pronto per login moderno');

                } catch (error) {
                    addSyncLog('❌ Errore sistema moderno: ' + error.message, 'error');
                    updateConnectionStatus('disconnected', 'Errore configurazione');
                }
            });
        }

        // Fallback per caricamento Google API
        function checkGoogleAPI() {
            if (typeof gapi !== 'undefined') {
                addSyncLog('✅ Google API trovata (fallback)', 'success');
                initGoogleAPI();
                return true;
            }
            return false;
        }

        console.log('🎉 JavaScript WebApp Agenda con Google Calendar caricato!');
    </script>
</body>
</html>
