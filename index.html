<div class="export-section">
                    <h3>📤 Export & Sync</h3>
                    <button class="btn btn-export" onclick="exportToCSV()">📊 Esporta CSV</button>
                    <button class="btn btn-export" onclick="syncAllEvents()">🔄 Sync Completo</button>
                </div>

                <div class="routine-list">
                    <h3>⏰ Routine Giornaliera</h3>
                    <div class="routine-item">
                        <div class="routine-time">7:00-8:45</div>
                        <div class="routine-task">🐕 Uscita mattutina Babu</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">9:00</div>
                        <div class="routine-task">☕ Colazione + 💊 Medicina Annamaria</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">12:15-13:00</div>
                        <div class="routine-task">🏃 Parco Babu + Ginnastica</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">17:00</div>
                        <div class="routine-task">💊 Medicina Annamaria</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">18:30-20:00</div>
                        <div class="routine-task">🐕 Uscita serale Babu</div>
                    </div>
                    <div class="routine-item">
                        <div class="routine-time">22:30</div>
                        <div class="routine-task">💊 Medicina + 🎮 Tempo libero</div>
                    </div>
                </div>

                <div class="ai-chat">
                    <div class="chat-header">🤖 Assistente AI</div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message">👋 Ciao! Dimmi cosa devi fare e ti suggerisco quando inserirlo in agenda.</div>
                    </div>
                    <input type="text" id="chatInput" class="chat-input" placeholder="Es: Devo andare dai vigili urbani...">
                    <button class="btn" onclick="sendMessage()">Invia Richiesta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURAZIONE -->
    <div class="modal-overlay" id="configModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeConfigModal()">×</button>
            <div class="modal-title">⚙️ Configurazione Google Calendar</div>
            
            <div class="modal-help">
                <h4>Come configurare l'integrazione:</h4>
                <ol>
                    <li>Vai su <strong>Google Cloud Console</strong> e crea un progetto</li>
                    <li>Abilita <strong>Google Calendar API</strong></li>
                    <li>Crea credenziali OAuth 2.0 e API Key</li>
                    <li>Autorizza il dominio della tua app</li>
                    <li>Copia Client ID e API Key qui sotto</li>
                    <li>Il sistema si collegherà direttamente alle Google Calendar API</li>
                </ol>
            </div>

            <div class="modal-form-group">
                <label for="googleClientId">Google OAuth Client ID:</label>
                <input type="text" id="googleClientId" class="modal-form-control" 
                       placeholder="123456789-xxxxxxxx.apps.googleusercontent.com">
            </div>

            <div class="modal-form-group">
                <label for="googleApiKey">Google Calendar API Key:</label>
                <input type="password" id="googleApiKey" class="modal-form-control" 
                       placeholder="AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXX">
            </div>

            <div class="modal-form-group">
                <label for="calendarId">Google Calendar ID:</label>
                <input type="text" id="calendarId" class="modal-form-control" 
                       placeholder="primary (o ID specifico del calendario)">
            </div>

            <div class="modal-form-group">
                <label for="syncInterval">Intervallo Sincronizzazione (minuti):</label>
                <select id="syncInterval" class="modal-form-control">
                    <option value="5">5 minuti</option>
                    <option value="15" selected>15 minuti</option>
                    <option value="30">30 minuti</option>
                    <option value="60">1 ora</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="modal-btn save" onclick="saveConfig()">💾 Salva Configurazione</button>
                <button class="modal-btn cancel" onclick="closeConfigModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- POPUP DETTAGLI EVENTI -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup()">×</button>
            <div class="popup-title" id="popupTitle"></div>
            <div class="popup-time" id="popupTime"></div>
            <div class="popup-description" id="popupDescription"></div>
            <div class="popup-actions">
                <button class="modal-btn" onclick="editEvent()">✏️ Modifica</button>
                <button class="modal-btn" onclick="deleteEvent()">🗑️ Elimina</button>
            </div>
        </div>
    </div>

    <button class="floating-help" onclick="showHelp()" title="Aiuto">❓</button>

    <script>
        console.log('🚀 Caricamento WebApp Agenda con Google Calendar Integration...');

        // VARIABILI GLOBALI
        let currentDate = new Date();
        let selectedDate = new Date();
        let tasks = {};
        let syncInterval = null;
        let midnightInterval = null;
        let isConnected = false;
        let currentEvent = null;

        // CONFIGURAZIONE GOOGLE CALENDAR
        const calendarConfig = {
            googleClientId: '',
            googleApiKey: '',
            calendarId: 'primary',
            syncInterval: 15,
            lastSync: null,
            syncedEvents: new Set()
        };

        // ROUTINE FISSE
        const fixedRoutine = {
            '07:00': '⏰ Sveglia + 🐕 Uscita Babu',
            '09:00': '☕ Colazione + 💊 Medicina Annamaria',
            '12:15': '🏃 Parco Babu + Ginnastica',
            '13:30': '🍽️ Pranzo',
            '17:00': '💊 Medicina Annamaria',
            '18:30': '🐕 Uscita serale Babu',
            '20:30': '🍽️ Cena',
            '22:30': '💊 Medicina Annamaria + 🎮 Tempo libero'
        };

        const reinaSchedule = {
            1: 'Reina: Bagni + Cucina',
            3: 'Reina: Camere + Biancheria',
            5: 'Reina: Pulizie generali'
        };

        // FUNZIONI UTILITÀ
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('it-IT', options);
        }

        function addChatMessage(message) {
            try {
                const container = document.getElementById('chatMessages');
                if (container) {
                    const div = document.createElement('div');
                    div.className = 'chat-message';
                    div.textContent = message;
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                }
                console.log('CHAT:', message);
            } catch (error) {
                console.log('CHAT (fallback):', message);
            }
        }

        function addSyncLog(message, type = 'info') {
            try {
                const container = document.getElementById('syncLog');
                if (container) {
                    const div = document.createElement('div');
                    div.className = `sync-log-entry ${type}`;
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                    
                    // Mantieni solo gli ultimi 10 log
                    if (container.children.length > 10) {
                        container.removeChild(container.firstChild);
                    }
                }
            } catch (error) {
                console.log('SYNC LOG:', message);
            }
        }

        // GOOGLE CALENDAR API INTEGRATION - Versione GitHub Pages
        function initGoogleCalendarAPI() {
            if (!calendarConfig.googleClientId || !calendarConfig.googleApiKey) {
                addSyncLog('Configurazione Google API mancante', 'error');
                return;
            }

            addSyncLog('Inizializzazione Google Calendar API...', 'info');
            
            // Per GitHub Pages, usiamo direttamente le Google API legacy
            // che sono più stabili per domini statici
            loadGoogleAPIDirectly();
        }

        function loadGoogleAPIDirectly() {
            addSyncLog('Caricamento Google API per GitHub Pages...', 'info');
            
            if (window.gapi) {
                addSyncLog('Google API già caricata', 'success');
                loadGoogleAPI();
                return;
            }
            
            // Carica direttamente le Google API con timeout esteso
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.async = true;
            script.defer = true;
            
            let loaded = false;
            
            script.onload = () => {
                if (!loaded) {
                    loaded = true;
                    addSyncLog('Google API caricata con successo', 'success');
                    loadGoogleAPI();
                }
            };
            
            script.onerror = () => {
                if (!loaded) {
                    loaded = true;
                    addSyncLog('Errore caricamento Google API - Provo CDN alternativo', 'error');
                    loadAlternativeGoogleAPI();
                }
            };
            
            document.head.appendChild(script);
            
            // Timeout più lungo per connessioni lente
            setTimeout(() => {
                if (!loaded && !window.gapi) {
                    loaded = true;
                    addSyncLog('Timeout Google API - Provo metodo alternativo', 'error');
                    loadAlternativeGoogleAPI();
                }
            }, 15000); // 15 secondi invece di 5
        }

        function loadAlternativeGoogleAPI() {
            addSyncLog('Tentativo caricamento da CDN alternativo...', 'info');
            
            // Prova con URL alternativo
            const script = document.createElement('script');
            script.src = 'https://www.gstatic.com/charts/loader.js';
            script.onload = () => {
                addSyncLog('CDN alternativo caricato, ma Google API non disponibile', 'error');
                showGitHubPagesHelp();
            };
            script.onerror = () => {
                addSyncLog('Tutti i CDN falliti', 'error');
                showGitHubPagesHelp();
            };
            document.head.appendChild(script);
        }

        function loadGoogleAPI() {
            addSyncLog('Inizializzazione moduli Google API...', 'info');
            
            try {
                gapi.load('client:auth2', {
                    callback: () => {
                        addSyncLog('Moduli caricati con successo', 'success');
                        initGoogleClient();
                    },
                    onerror: () => {
                        addSyncLog('Errore caricamento moduli', 'error');
                        showGitHubPagesHelp();
                    },
                    timeout: 20000, // 20 secondi
                    ontimeout: () => {
                        addSyncLog('Timeout moduli Google API', 'error');
                        showGitHubPagesHelp();
                    }
                });
            } catch (error) {
                addSyncLog('Errore in gapi.load: ' + error.message, 'error');
                showGitHubPagesHelp();
            }
        }

        function initGoogleClient() {
            addSyncLog('Configurazione client Google Calendar...', 'info');
            
            const initConfig = {
                apiKey: calendarConfig.googleApiKey,
                clientId: calendarConfig.googleClientId,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                scope: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events'
            };
            
            gapi.client.init(initConfig).then(() => {
                addSyncLog('Google Calendar API inizializzata con successo', 'success');
                
                // Controlla autenticazione
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    addSyncLog('Utente già autenticato', 'success');
                    updateConnectionStatus(true);
                    updateSyncIndicator('connected');
                    
                    // Test immediato
                    testCalendarAccess();
                } else {
                    addSyncLog('Pronto per autenticazione', 'info');
                    updateConnectionStatus(false);
                    updateSyncIndicator('disconnected');
                }
            }).catch(error => {
                addSyncLog('Errore inizializzazione client:', 'error');
                
                if (error.details) {
                    addSyncLog('Dettagli: ' + error.details, 'error');
                }
                
                // Errori specifici per GitHub Pages
                if (error.error === 'idpiframe_initialization_failed') {
                    addSyncLog('Errore iframe - Verifica dominio in Google Cloud Console', 'error');
                    showDomainConfigHelp();
                } else if (error.error === 'popup_blocked_by_browser') {
                    addSyncLog('Popup bloccato - Abilita popup per questo sito', 'error');
                } else {
                    addSyncLog('Errore generico: ' + JSON.stringify(error), 'error');
                }
                
                updateConnectionStatus(false);
                updateSyncIndicator('disconnected');
            });
        }

        function showGitHubPagesHelp() {
            addSyncLog('=== GUIDA RISOLUZIONE GITHUB PAGES ===', 'info');
            addSyncLog('1. Verifica che il sito sia servito via HTTPS', 'info');
            addSyncLog('2. Controlla dominio in Google Cloud Console', 'info');
            addSyncLog('3. Disabilita adblocker temporaneamente', 'info');
            addSyncLog('4. Prova modalità incognito', 'info');
            addSyncLog('5. Verifica firewall/proxy aziendale', 'info');
            
            setTimeout(() => {
                const currentUrl = window.location.href;
                let helpMessage = '❌ Impossibile caricare Google Calendar API\n\n';
                
                if (currentUrl.startsWith('https://')) {
                    helpMessage += '✅ HTTPS: OK\n';
                } else {
                    helpMessage += '❌ HTTPS: Richiesto per Google API\n';
                }
                
                helpMessage += '\nVerifica:\n';
                helpMessage += '• Dominio autorizzato in Google Cloud Console\n';
                helpMessage += '• Adblocker disabilitato\n';
                helpMessage += '• Popup abilitati\n';
                helpMessage += '• Connessione internet stabile\n\n';
                helpMessage += 'URL corrente: ' + currentUrl + '\n\n';
                helpMessage += 'Vuoi attivare la modalità test?';
                
                if (confirm(helpMessage)) {
                    enableManualMode();
                }
            }, 2000);
        }

        function showDomainConfigHelp() {
            addSyncLog('=== CONFIGURAZIONE DOMINIO RICHIESTA ===', 'info');
            const currentDomain = window.location.origin;
            addSyncLog('Dominio corrente: ' + currentDomain, 'info');
            addSyncLog('Aggiungi questo dominio in Google Cloud Console:', 'info');
            addSyncLog('API e servizi → Credenziali → OAuth Client ID', 'info');
            addSyncLog('Origini JavaScript autorizzate → + AGGIUNGI URI', 'info');
            addSyncLog('Inserisci: ' + currentDomain, 'info');
            
            setTimeout(() => {
                alert(`🔧 Configurazione dominio richiesta\n\n` +
                      `Aggiungi questo dominio in Google Cloud Console:\n\n` +
                      `${currentDomain}\n\n` +
                      `Percorso:\n` +
                      `API e servizi → Credenziali → OAuth Client ID\n` +
                      `→ Origini JavaScript autorizzate\n` +
                      `→ + AGGIUNGI URI\n\n` +
                      `Dopo aver aggiunto, ricarica la pagina.`);
            }, 1000);
        }

        // Funzione per test manuale senza Google API
        function enableManualMode() {
            addSyncLog('=== MODALITÀ MANUALE ATTIVATA ===', 'info');
            addSyncLog('Google API non disponibile, simulazione eventi', 'info');
            
            // Simula connessione per test
            updateConnectionStatus(true);
            updateSyncIndicator('connected');
            
            // Override delle funzioni API con simulazioni
            window.simulateGoogleCalendar = true;
            
            addChatMessage('⚠️ Modalità test attivata - Google API non disponibile');
            addChatMessage('📝 Puoi comunque usare l\'agenda normalmente');
        }

        function loadGoogleAPI() {
            addSyncLog('Caricamento moduli Google API...', 'info');
            
            try {
                gapi.load('client:auth2', {
                    callback: () => {
                        addSyncLog('Moduli Google API caricati', 'success');
                        initGoogleClient();
                    },
                    onerror: () => {
                        addSyncLog('Errore caricamento moduli Google API', 'error');
                        updateConnectionStatus(false);
                    },
                    timeout: 10000, // 10 secondi timeout
                    ontimeout: () => {
                        addSyncLog('Timeout caricamento Google API', 'error');
                        updateConnectionStatus(false);
                    }
                });
            } catch (error) {
                addSyncLog('Errore in gapi.load: ' + error.message, 'error');
                updateConnectionStatus(false);
            }
        }

        function initGoogleClient() {
            addSyncLog('Inizializzazione client Google...', 'info');
            
            const initConfig = {
                apiKey: calendarConfig.googleApiKey,
                clientId: calendarConfig.googleClientId,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                scope: 'https://www.googleapis.com/auth/calendar'
            };
            
            addSyncLog('Config: API Key presente: ' + (!!initConfig.apiKey), 'info');
            addSyncLog('Config: Client ID presente: ' + (!!initConfig.clientId), 'info');
            
            gapi.client.init(initConfig).then(() => {
                addSyncLog('Google Calendar API inizializzata con successo', 'success');
                
                // Controlla se già autenticato
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    addSyncLog('Utente già autenticato', 'success');
                    updateConnectionStatus(true);
                    updateSyncIndicator('connected');
                } else {
                    addSyncLog('Autenticazione richiesta', 'info');
                    updateConnectionStatus(false);
                    updateSyncIndicator('disconnected');
                }
            }).catch(error => {
                addSyncLog('Errore inizializzazione Google API:', 'error');
                addSyncLog('Dettaglio errore: ' + JSON.stringify(error), 'error');
                
                // Analizza errori specifici
                if (error.error) {
                    switch (error.error) {
                        case 'invalid_client':
                            addSyncLog('Client ID non valido - Verifica configurazione', 'error');
                            break;
                        case 'invalid_request':
                            addSyncLog('Richiesta non valida - Verifica API Key', 'error');
                            break;
                        case 'access_denied':
                            addSyncLog('Accesso negato - Verifica permessi', 'error');
                            break;
                        default:
                            addSyncLog('Errore: ' + error.error, 'error');
                    }
                }
                
                updateConnectionStatus(false);
                updateSyncIndicator('disconnected');
            });
        }

        function authenticateGoogle() {
            if (!window.gapi || !gapi.auth2) {
                addSyncLog('Google API non inizializzata correttamente', 'error');
                return;
            }

            addSyncLog('Avvio autenticazione Google...', 'info');
            updateSyncIndicator('syncing');

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (!authInstance) {
                    addSyncLog('Istanza auth non disponibile', 'error');
                    updateSyncIndicator('disconnected');
                    return;
                }

                // Per GitHub Pages, usiamo parametri più permissivi
                authInstance.signIn({
                    prompt: 'select_account',
                    ux_mode: 'popup',
                    redirect_uri: window.location.origin
                }).then(() => {
                    addSyncLog('Autenticazione Google completata', 'success');
                    updateConnectionStatus(true);
                    updateSyncIndicator('connected');
                    
                    // Test immediato dopo autenticazione
                    testCalendarAccess();
                    
                }).catch(error => {
                    addSyncLog('Errore autenticazione: ' + JSON.stringify(error), 'error');
                    
                    if (error.error === 'popup_closed_by_user') {
                        addSyncLog('Popup chiuso dall\'utente', 'info');
                    } else if (error.error === 'access_denied') {
                        addSyncLog('Accesso negato - Autorizza l\'applicazione', 'error');
                    } else if (error.error === 'popup_blocked_by_browser') {
                        addSyncLog('Popup bloccato dal browser', 'error');
                        setTimeout(() => {
                            alert('🚫 Popup bloccato\n\nAbilita i popup per questo sito e riprova.\n\nNel browser:\n• Clicca sull\'icona popup nella barra indirizzi\n• Seleziona "Consenti sempre popup"');
                        }, 1000);
                    }
                    
                    updateConnectionStatus(false);
                    updateSyncIndicator('disconnected');
                });
            } catch (error) {
                addSyncLog('Errore durante signIn: ' + error.message, 'error');
                updateConnectionStatus(false);
                updateSyncIndicator('disconnected');
            }
        }

        async function testCalendarAccess() {
            addSyncLog('Test accesso Calendar API...', 'info');
            
            try {
                // Test semplice: ottieni lista calendari
                const response = await gapi.client.calendar.calendarList.list({
                    maxResults: 1
                });
                
                if (response && response.result) {
                    addSyncLog('Test Calendar API: OK', 'success');
                    addSyncLog('Calendari disponibili: ' + (response.result.items?.length || 0), 'info');
                    return true;
                } else {
                    addSyncLog('Test Calendar API: Risposta vuota', 'error');
                    return false;
                }
            } catch (error) {
                addSyncLog('Test Calendar API fallito: ' + error.message, 'error');
                
                if (error.status === 403) {
                    addSyncLog('Errore 403: Calendar API non abilitata o quota superata', 'error');
                } else if (error.status === 401) {
                    addSyncLog('Errore 401: Token non valido, richiesta nuova autenticazione', 'error');
                }
                
                return false;
            }
        }

        async function fetchGoogleCalendarEvents(dateStart, dateEnd) {
            if (!gapi.client.calendar) {
                throw new Error('Google Calendar API non inizializzata');
            }

            try {
                const response = await gapi.client.calendar.events.list({
                    calendarId: calendarConfig.calendarId,
                    timeMin: dateStart.toISOString(),
                    timeMax: dateEnd.toISOString(),
                    singleEvents: true,
                    orderBy: 'startTime'
                });

                return response.result.items || [];
            } catch (error) {
                console.error('Errore fetch eventi Google Calendar:', error);
                throw error;
            }
        }

        async function createGoogleCalendarEvent(event) {
            if (!gapi.client.calendar) {
                throw new Error('Google Calendar API non inizializzata');
            }

            const startDateTime = new Date(event.date + 'T' + (event.time || '09:00') + ':00');
            const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // +1 ora

            const calendarEvent = {
                summary: event.title,
                description: event.description || 'Evento creato da Agenda WebApp',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                }
            };

            try {
                const response = await gapi.client.calendar.events.insert({
                    calendarId: calendarConfig.calendarId,
                    resource: calendarEvent
                });

                return response.result;
            } catch (error) {
                console.error('Errore creazione evento Google Calendar:', error);
                throw error;
            }
        }

        // FUNZIONI CONFIGURAZIONE
        function openConfigModal() {
            const saved = localStorage.getItem('calendarConfig');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('googleClientId').value = config.googleClientId || '';
                document.getElementById('googleApiKey').value = config.googleApiKey || '';
                document.getElementById('calendarId').value = config.calendarId || 'primary';
                document.getElementById('syncInterval').value = config.syncInterval || 15;
            }
            
            document.getElementById('configModal').style.display = 'flex';
            addDebugButton(); // Aggiungi pulsante debug
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        function saveConfig() {
            const config = {
                googleClientId: document.getElementById('googleClientId').value.trim(),
                googleApiKey: document.getElementById('googleApiKey').value.trim(),
                calendarId: document.getElementById('calendarId').value.trim(),
                syncInterval: parseInt(document.getElementById('syncInterval').value),
                lastSync: null,
                syncedEvents: []
            };

            if (!config.googleClientId || !config.googleApiKey) {
                alert('⚠️ Inserisci Google Client ID e API Key per continuare');
                return;
            }

            localStorage.setItem('calendarConfig', JSON.stringify(config));
            
            calendarConfig.googleClientId = config.googleClientId;
            calendarConfig.googleApiKey = config.googleApiKey;
            calendarConfig.calendarId = config.calendarId;
            calendarConfig.syncInterval = config.syncInterval;
            calendarConfig.lastSync = config.lastSync;
            
            closeConfigModal();
            addSyncLog('Configurazione salvata con successo', 'success');
            addChatMessage('✅ Configurazione Google Calendar salvata');
            
            initGoogleCalendarAPI();
            startAutoSync();
            setTimeout(() => testConnection(), 1000);
        }

        function testConnection() {
            if (!calendarConfig.googleClientId || !calendarConfig.googleApiKey) {
                addSyncLog('Configurazione Google API mancante', 'error');
                updateConnectionStatus(false);
                return;
            }

            addSyncLog('=== INIZIO TEST CONNESSIONE ===', 'info');
            addSyncLog('Client ID: ' + calendarConfig.googleClientId.substring(0, 20) + '...', 'info');
            addSyncLog('API Key: ' + calendarConfig.googleApiKey.substring(0, 10) + '...', 'info');
            
            updateSyncIndicator('syncing');

            // Se Google API non è ancora caricata, inizializza
            if (!window.gapi) {
                addSyncLog('Google API non caricata, inizializzazione...', 'info');
                initGoogleCalendarAPI();
                return;
            }

            // Se client non è inizializzato, inizializza
            if (!gapi.client || !gapi.client.calendar) {
                addSyncLog('Client Google non inizializzato, inizializzazione...', 'info');
                initGoogleClient();
                return;
            }

            // Verifica se già autenticato
            if (gapi.auth2) {
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    addSyncLog('Utente già autenticato, test accesso...', 'success');
                    updateConnectionStatus(true);
                    updateSyncIndicator('connected');
                    
                    // Test accesso API
                    testCalendarAccess().then(success => {
                        if (success) {
                            addSyncLog('=== TEST CONNESSIONE COMPLETATO CON SUCCESSO ===', 'success');
                        } else {
                            addSyncLog('=== TEST CONNESSIONE FALLITO ===', 'error');
                        }
                    });
                } else {
                    addSyncLog('Utente non autenticato, richiesta autenticazione...', 'info');
                    authenticateGoogle();
                }
            } else {
                addSyncLog('Auth2 non disponibile, reinizializzazione...', 'error');
                initGoogleClient();
            }
        }

        // Aggiungi funzione di debug
        function debugGoogleAPI() {
            addSyncLog('=== DEBUG GOOGLE API ===', 'info');
            addSyncLog('window.gapi disponibile: ' + !!window.gapi, 'info');
            
            if (window.gapi) {
                addSyncLog('gapi.client disponibile: ' + !!gapi.client, 'info');
                addSyncLog('gapi.auth2 disponibile: ' + !!gapi.auth2, 'info');
                
                if (gapi.client) {
                    addSyncLog('gapi.client.calendar disponibile: ' + !!gapi.client.calendar, 'info');
                }
                
                if (gapi.auth2) {
                    const authInstance = gapi.auth2.getAuthInstance();
                    addSyncLog('AuthInstance disponibile: ' + !!authInstance, 'info');
                    
                    if (authInstance) {
                        addSyncLog('Utente autenticato: ' + authInstance.isSignedIn.get(), 'info');
                    }
                }
            }
            addSyncLog('=== FINE DEBUG ===', 'info');
        }

        // Aggiungi pulsante modalità manuale (versione corretta)
        function addDebugButton() {
            setTimeout(() => {
                const configModal = document.getElementById('configModal');
                if (configModal) {
                    const modalActions = configModal.querySelector('.modal-actions');
                    if (!modalActions) return;

                    // Rimuovi pulsanti esistenti per evitare duplicati
                    const existingDebug = modalActions.querySelector('.debug-btn');
                    const existingManual = modalActions.querySelector('.manual-btn');
                    if (existingDebug) existingDebug.remove();
                    if (existingManual) existingManual.remove();

                    // Crea pulsante debug
                    const debugBtn = document.createElement('button');
                    debugBtn.className = 'modal-btn debug-btn';
                    debugBtn.textContent = '🔍 Debug API';
                    debugBtn.onclick = debugGoogleAPI;
                    debugBtn.style.background = '#e67e22';
                    
                    // Crea pulsante modalità test
                    const manualBtn = document.createElement('button');
                    manualBtn.className = 'modal-btn manual-btn';
                    manualBtn.textContent = '🧪 Modalità Test';
                    manualBtn.onclick = enableManualMode;
                    manualBtn.style.background = '#9b59b6';
                    
                    // Aggiungi i pulsanti
                    modalActions.appendChild(debugBtn);
                    modalActions.appendChild(manualBtn);
                }
            }, 100);
        }

        // Aggiungi controllo ambiente
        function checkEnvironment() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            addSyncLog('=== CONTROLLO AMBIENTE ===', 'info');
            addSyncLog('Protocollo: ' + protocol, 'info');
            addSyncLog('Hostname: ' + hostname, 'info');
            
            if (protocol === 'file:') {
                addSyncLog('⚠️ Protocollo file:// rilevato', 'error');
                addSyncLog('Google API potrebbe non funzionare', 'error');
                addSyncLog('Suggerimento: Usa un server HTTP locale', 'info');
                
                setTimeout(() => {
                    if (confirm('⚠️ Stai usando file:// locale\n\nGoogle Calendar API potrebbe non funzionare.\nVuoi attivare la modalità test?')) {
                        enableManualMode();
                    }
                }, 2000);
            }
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                addSyncLog('✅ Server locale rilevato', 'success');
            }
            
            // Controlla se Google è raggiungibile
            testGoogleReachability();
        }

        function testGoogleReachability() {
            addSyncLog('Test raggiungibilità Google...', 'info');
            
            const img = new Image();
            img.onload = () => {
                addSyncLog('✅ Google raggiungibile', 'success');
            };
            img.onerror = () => {
                addSyncLog('❌ Google non raggiungibile', 'error');
                addSyncLog('Verifica connessione internet o firewall', 'error');
            };
            img.src = 'https://www.google.com/favicon.ico?' + Date.now();
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('syncStatusText');
            
            if (connected) {
                statusElement.textContent = 'Connesso';
                statusElement.className = 'connection-status connected';
                textElement.textContent = 'Connesso';
            } else {
                statusElement.textContent = 'Disconnesso';
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = 'Disconnesso';
            }
        }

        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            indicator.className = `sync-indicator ${status}`;
        }

        async function manualSync() {
            if (!isConnected) {
                addSyncLog('Connessione richiesta per la sincronizzazione', 'error');
                return;
            }

            if (!gapi.auth2 || !gapi.auth2.getAuthInstance().isSignedIn.get()) {
                addSyncLog('Autenticazione Google richiesta', 'error');
                authenticateGoogle();
                return;
            }

            addSyncLog('Sincronizzazione con Google Calendar...', 'info');
            updateSyncIndicator('syncing');
            
            try {
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);

                const googleEvents = await fetchGoogleCalendarEvents(weekStart, weekEnd);
                
                let importedCount = 0;
                googleEvents.forEach(googleEvent => {
                    if (!googleEvent.start.dateTime) return;
                    
                    const eventDate = new Date(googleEvent.start.dateTime);
                    const dateKey = formatDateKey(eventDate);
                    const eventTime = eventDate.toTimeString().substring(0, 5);
                    
                    if (!tasks[dateKey]) {
                        tasks[dateKey] = [];
                    }
                    
                    const existingEvent = tasks[dateKey].find(task => 
                        task.googleEventId === googleEvent.id ||
                        (task.title === googleEvent.summary && task.time === eventTime)
                    );
                    
                    if (!existingEvent) {
                        tasks[dateKey].push({
                            title: googleEvent.summary,
                            time: eventTime,
                            type: 'work',
                            id: 'google_' + googleEvent.id,
                            googleEventId: googleEvent.id,
                            synced: true,
                            source: 'google_calendar',
                            description: googleEvent.description || 'Importato da Google Calendar'
                        });
                        importedCount++;
                    }
                });

                Object.values(tasks).forEach(dayTasks => {
                    dayTasks.sort((a, b) => {
                        if (!a.time && !b.time) return 0;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });
                });

                addSyncLog(`Sincronizzazione completata: ${importedCount} eventi importati`, 'success');
                updateSyncIndicator('connected');
                updateDisplay();
                updateSyncedEventsCount();
                
            } catch (error) {
                addSyncLog('Errore durante la sincronizzazione: ' + error.message, 'error');
                updateSyncIndicator('disconnected');
            }
        }

        function startAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            if (calendarConfig.syncInterval > 0) {
                syncInterval = setInterval(() => {
                    if (isConnected) {
                        manualSync();
                    }
                }, calendarConfig.syncInterval * 60000);
                
                addSyncLog(`Auto-sync attivato ogni ${calendarConfig.syncInterval} minuti`, 'info');
            }
        }

        function startMidnightUpdate() {
            if (midnightInterval) {
                clearInterval(midnightInterval);
            }
            
            function msUntilMidnight() {
                const now = new Date();
                const midnight = new Date();
                midnight.setHours(24, 0, 0, 0);
                return midnight.getTime() - now.getTime();
            }
            
            setTimeout(() => {
                updateToToday();
                midnightInterval = setInterval(updateToToday, 24 * 60 * 60 * 1000);
            }, msUntilMidnight());
            
            addSyncLog('Aggiornamento automatico data attivato', 'info');
        }

        function updateToToday() {
            const now = new Date();
            const wasToday = formatDateKey(selectedDate) === formatDateKey(new Date(now.getTime() - 24 * 60 * 60 * 1000));
            
            if (wasToday) {
                currentDate = new Date();
                selectedDate = new Date();
                updateDisplay();
                updateStats();
                
                const newDate = formatDateDisplay(new Date());
                addChatMessage(`🌅 Nuovo giorno: ${newDate}`);
                addSyncLog(`Data aggiornata automaticamente: ${newDate}`, 'info');
            }
        }

        async function syncDay() {
            if (!isConnected) {
                addSyncLog('Connessione richiesta per sincronizzare il giorno', 'error');
                return;
            }

            if (!gapi.auth2 || !gapi.auth2.getAuthInstance().isSignedIn.get()) {
                addSyncLog('Autenticazione Google richiesta', 'error');
                authenticateGoogle();
                return;
            }

            const dateKey = formatDateKey(selectedDate);
            const dayTasks = tasks[dateKey] || [];
            
            addSyncLog(`Sincronizzazione giorno ${dateKey}...`, 'info');
            
            try {
                const localEvents = dayTasks.filter(task => 
                    !task.googleEventId && 
                    task.syncToCalendar !== false &&
                    task.source !== 'google_calendar'
                );
                
                let syncedCount = 0;
                for (const task of localEvents) {
                    try {
                        const googleEvent = await createGoogleCalendarEvent({
                            title: task.title,
                            description: task.description,
                            date: dateKey,
                            time: task.time
                        });
                        
                        task.synced = true;
                        task.googleEventId = googleEvent.id;
                        calendarConfig.syncedEvents.add(task.id);
                        syncedCount++;
                    } catch (error) {
                        addSyncLog(`Errore sync evento "${task.title}": ${error.message}`, 'error');
                    }
                }
                
                addSyncLog(`${syncedCount} eventi sincronizzati per ${dateKey}`, 'success');
                updateDisplay();
                updateSyncedEventsCount();
                
            } catch (error) {
                addSyncLog(`Errore sincronizzazione giorno: ${error.message}`, 'error');
            }
        }

        async function importDay() {
            if (!isConnected) {
                addSyncLog('Connessione richiesta per importare eventi', 'error');
                return;
            }

            if (!gapi.auth2 || !gapi.auth2.getAuthInstance().isSignedIn.get()) {
                addSyncLog('Autenticazione Google richiesta', 'error');
                authenticateGoogle();
                return;
            }

            const dateKey = formatDateKey(selectedDate);
            addSyncLog(`Import eventi da Google Calendar per ${dateKey}...`, 'info');
            
            try {
                const dayStart = new Date(selectedDate);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(selectedDate);
                dayEnd.setHours(23, 59, 59, 999);
                
                const googleEvents = await fetchGoogleCalendarEvents(dayStart, dayEnd);
                
                if (!tasks[dateKey]) {
                    tasks[dateKey] = [];
                }
                
                let importedCount = 0;
                googleEvents.forEach(googleEvent => {
                    if (!googleEvent.start.dateTime) return;
                    
                    const eventDate = new Date(googleEvent.start.dateTime);
                    const eventTime = eventDate.toTimeString().substring(0, 5);
                    
                    const existingEvent = tasks[dateKey].find(task => 
                        task.googleEventId === googleEvent.id
                    );
                    
                    if (!existingEvent) {
                        tasks[dateKey].push({
                            title: googleEvent.summary || 'Evento Google Calendar',
                            time: eventTime,
                            type: 'work',
                            id: 'google_' + googleEvent.id + '_' + Date.now(),
                            googleEventId: googleEvent.id,
                            synced: true,
                            source: 'google_calendar',
                            description: googleEvent.description || 'Importato da Google Calendar'
                        });
                        importedCount++;
                    }
                });
                
                tasks[dateKey].sort((a, b) => {
                    if (!a.time && !b.time) return 0;
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });
                
                addSyncLog(`${importedCount} eventi importati`, 'success');
                updateDisplay();
                updateSyncedEventsCount();
                
            } catch (error) {
                addSyncLog(`Errore import eventi: ${error.message}`, 'error');
            }
        }

        async function syncAllEvents() {
            if (!isConnected) {
                addSyncLog('Connessione richiesta per sincronizzazione completa', 'error');
                return;
            }

            addSyncLog('Sincronizzazione completa avviata...', 'info');
            updateSyncIndicator('syncing');
            
            let totalEvents = 0;
            Object.values(tasks).forEach(dayTasks => {
                totalEvents += dayTasks.length;
            });
            
            setTimeout(() => {
                addSyncLog(`Sincronizzazione completa: ${totalEvents} eventi`, 'success');
                updateSyncIndicator('connected');
                
                Object.values(tasks).forEach(dayTasks => {
                    dayTasks.forEach(task => {
                        task.synced = true;
                        calendarConfig.syncedEvents.add(task.id);
                    });
                });
                
                updateDisplay();
                updateSyncedEventsCount();
            }, 3000);
        }

        function updateSyncedEventsCount() {
            let syncedCount = 0;
            Object.values(tasks).forEach(dayTasks => {
                dayTasks.forEach(task => {
                    if (task.synced) syncedCount++;
                });
            });
            
            document.getElementById('syncedEvents').textContent = syncedCount;
        }

        // FUNZIONI TASK
        function addTask() {
            try {
                const title = document.getElementById('taskTitle').value.trim();
                const dateInput = document.getElementById('taskDate').value;
                const time = document.getElementById('taskTime').value;
                const type = document.getElementById('taskType').value;
                const syncToCalendar = document.getElementById('syncToCalendar').checked;

                if (!title || !dateInput) {
                    alert('Inserisci almeno il titolo e la data del task!');
                    return;
                }

                const dateKey = dateInput;

                if (!tasks[dateKey]) {
                    tasks[dateKey] = [];
                }

                const newTask = {
                    title: title,
                    time: time,
                    type: type,
                    id: Date.now(),
                    synced: false,
                    syncToCalendar: syncToCalendar,
                    source: 'local'
                };

                tasks[dateKey].push(newTask);

                tasks[dateKey].sort(function(a, b) {
                    if (!a.time && !b.time) return 0;
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });

                document.getElementById('taskTitle').value = '';
                document.getElementById('taskTime').value = '';

                updateDisplay();
                updateStats();

                const taskDate = new Date(dateInput + 'T00:00:00');
                const formattedDate = taskDate.toLocaleDateString('it-IT');
                const timeText = time ? 'alle ' + time : 'senza orario specifico';
                addChatMessage('✅ Task "' + title + '" aggiunto per ' + formattedDate + ' ' + timeText);
                
                if (syncToCalendar && isConnected) {
                    if (gapi.auth2 && gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        setTimeout(async () => {
                            try {
                                const googleEvent = await createGoogleCalendarEvent({
                                    title: title,
                                    description: 'Creato da Agenda WebApp',
                                    date: dateInput,
                                    time: time
                                });
                                
                                newTask.synced = true;
                                newTask.googleEventId = googleEvent.id;
                                calendarConfig.syncedEvents.add(newTask.id);
                                updateDisplay();
                                updateSyncedEventsCount();
                                addSyncLog(`Task "${title}" sincronizzato con Google Calendar`, 'success');
                            } catch (error) {
                                addSyncLog(`Errore sync task "${title}": ${error.message}`, 'error');
                            }
                        }, 1000);
                    } else {
                        addChatMessage('⚠️ Autenticazione Google richiesta per la sincronizzazione');
                    }
                }
                
            } catch (error) {
                console.error('Errore addTask:', error);
                alert('Errore nell\'aggiunta del task');
            }
        }

        function editEvent() {
            if (!currentEvent) return;
            
            const newTitle = prompt('Modifica titolo:', currentEvent.title);
            if (newTitle && newTitle.trim()) {
                currentEvent.title = newTitle.trim();
                currentEvent.synced = false;
                updateDisplay();
                closePopup();
                addChatMessage('✏️ Evento modificato: ' + newTitle);
            }
        }

        function deleteEvent() {
            if (!currentEvent) return;
            
            if (confirm('Sei sicuro di voler eliminare questo evento?')) {
                const dateKey = formatDateKey(selectedDate);
                if (tasks[dateKey]) {
                    tasks[dateKey] = tasks[dateKey].filter(task => task.id !== currentEvent.id);
                    updateDisplay();
                    updateStats();
                    closePopup();
                    addChatMessage('🗑️ Evento eliminato');
                }
            }
        }

        function sendMessage() {
            try {
                const message = document.getElementById('chatInput').value.trim();
                if (!message) return;

                addChatMessage('Tu: ' + message);
                document.getElementById('chatInput').value = '';

                setTimeout(function() {
                    const response = generateAIResponse(message);
                    addChatMessage('🤖 ' + response);
                }, 1000);
                
            } catch (error) {
                console.error('Errore sendMessage:', error);
            }
        }

        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('sync') || lowerMessage.includes('calendario')) {
                return 'Per sincronizzare con Google Calendar, assicurati di aver configurato la connessione. Posso aiutarti a programmare l\'evento!';
            }
            
            if (lowerMessage.includes('vigili') || lowerMessage.includes('comune')) {
                return 'Per i vigili urbani, ti consiglio di andarci al mattino (10:00-11:30) quando c\'è meno coda. Vuoi che lo aggiunga e sincronizzo con Google Calendar?';
            }
            
            if (lowerMessage.includes('spesa') || lowerMessage.includes('supermercato')) {
                return 'La spesa è meglio farla nel pomeriggio (16:00-17:30) dopo la medicina di Annamaria. Così eviti la folla del weekend!';
            }
            
            if (lowerMessage.includes('orto') || lowerMessage.includes('giardino')) {
                return 'Per l\'orto il momento migliore è la mattina presto (7:00-8:00) o la sera (19:00-20:00) quando non c\'è troppo caldo.';
            }
            
            return 'Dimmi cosa devi fare e ti aiuto a trovare il momento migliore per inserirlo in agenda! 🎯';
        }

        function exportToCSV() {
            addChatMessage('📊 Generazione CSV in corso...');
            
            try {
                const csvData = generateSimpleCSV();
                downloadCSV(csvData, 'agenda_' + formatDateKey(new Date()) + '.csv');
                addChatMessage('📥 File CSV scaricato nella cartella Downloads');
                
            } catch (error) {
                console.error('Errore export CSV:', error);
                addChatMessage('❌ Errore durante export CSV');
            }
        }

        function generateSimpleCSV() {
            const csvData = ['Data,Ora,Titolo,Categoria,Sincronizzato,Fonte'];
            const today = new Date();
            
            Object.entries(fixedRoutine).forEach(function(entry) {
                const time = entry[0];
                const activity = entry[1];
                csvData.push('"' + today.toLocaleDateString('it-IT') + '","' + time + '","' + activity + '","Routine","No","Local"');
            });
            
            Object.entries(tasks).forEach(function(entry) {
                const date = entry[0];
                const dayTasks = entry[1];
                const formattedDate = new Date(date).toLocaleDateString('it-IT');
                
                dayTasks.forEach(function(task) {
                    const synced = task.synced ? 'Sì' : 'No';
                    const source = task.source || 'Local';
                    csvData.push('"' + formattedDate + '","' + (task.time || '') + '","' + task.title + '","' + (task.type || 'Generale') + '","' + synced + '","' + source + '"');
                });
            });
            
            return csvData.join('\n');
        }

        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // CARICAMENTO RACCOLTA DIFFERENZIATA
        function initDemoTasks() {
            console.log('🔄 Caricamento calendario raccolta differenziata 2025...');
            
            tasks = {};
            
            const wasteData = [
                '2025-07-04,ORGANICO / PANNOLINI','2025-07-06,PLASTICA E METALLI / PANNOLINI','2025-07-07,ORGANICO',
                '2025-07-08,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-09,ORGANICO','2025-07-10,VETRO',
                '2025-07-11,ORGANICO / PANNOLINI','2025-07-13,PLASTICA E METALLI / PANNOLINI','2025-07-14,ORGANICO',
                '2025-07-15,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-16,ORGANICO','2025-07-17,CARTA',
                '2025-07-18,ORGANICO / PANNOLINI','2025-07-20,PLASTICA E METALLI / PANNOLINI','2025-07-21,ORGANICO',
                '2025-07-22,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-23,ORGANICO','2025-07-24,VETRO',
                '2025-07-25,ORGANICO / PANNOLINI','2025-07-27,PLASTICA E METALLI / PANNOLINI','2025-07-28,ORGANICO',
                '2025-07-29,RESIDUO NON RICICLABILE / PANNOLINI','2025-07-30,ORGANICO','2025-07-31,CARTA'
            ];

            function getWasteEmoji(wasteType) {
                if (wasteType.includes('VETRO')) return '🥛';
                if (wasteType.includes('ORGANICO')) return '🍃';
                if (wasteType.includes('PLASTICA')) return '♻️';
                if (wasteType.includes('CARTA')) return '📄';
                if (wasteType.includes('RESIDUO')) return '🗑️';
                return '🗑️';
            }

            let loadedTasks = 0;
            wasteData.forEach(function(item) {
                const parts = item.split(',');
                const dateKey = parts[0];
                const wasteType = parts[1];
                
                if (!tasks[dateKey]) {
                    tasks[dateKey] = [];
                }
                
                const emoji = getWasteEmoji(wasteType);
                tasks[dateKey].push({
                    title: emoji + ' ' + wasteType,
                    time: '21:00',
                    type: 'house',
                    id: 'waste_' + dateKey,
                    description: 'Raccolta differenziata - Esporre dopo le 21:00',
                    synced: false,
                    syncToCalendar: false,
                    source: 'local'
                });
                
                loadedTasks++;
            });

            console.log('✅ Calendario raccolta differenziata caricato');
            console.log('📊 Totale giorni:', loadedTasks);
        }

        function updateStats() {
            const today = formatDateKey(new Date());
            const todayTasks = (tasks[today] && Array.isArray(tasks[today])) ? tasks[today].length : 0;
            
            const tasksElement = document.getElementById('tasksToday');
            if (tasksElement) tasksElement.textContent = todayTasks;
            
            updateSyncedEventsCount();
        }

        function updateDisplay() {
            updateCalendarDisplay();
            updateDailySchedule();
        }

        function updateCalendarDisplay() {
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
                "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            
            const monthDisplay = document.getElementById('currentMonth');
            if (monthDisplay) {
                monthDisplay.textContent = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            }

            generateCalendar();
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            if (!calendar) return;
            
            calendar.innerHTML = '';

            const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            dayNames.forEach(function(day) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startingDayOfWeek = (firstDay.getDay() + 6) % 7;

            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = new Date(firstDay);
                day.setDate(day.getDate() - i - 1);
                createDayElement(day, true);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                createDayElement(date, false);
            }

            const remainingCells = 42 - (startingDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, day);
                createDayElement(date, true);
            }
        }

        function createDayElement(date, isOtherMonth) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            if (isOtherMonth) dayElement.classList.add('other-month');
            
            const dateKey = formatDateKey(date);
            const selectedDateKey = formatDateKey(selectedDate);
            const todayKey = formatDateKey(new Date());
            
            if (dateKey === selectedDateKey) {
                dayElement.classList.add('selected');
            }
            
            if (dateKey === todayKey && !isOtherMonth) {
                dayElement.classList.add('today');
            }

            dayElement.innerHTML = '<div class="day-number">' + date.getDate() + '</div>' +
                                   '<div class="day-events" id="events-' + dateKey + '"></div>';

            dayElement.onclick = function() { selectDate(date); };
            document.getElementById('calendar').appendChild(dayElement);

            updateDayEvents(date, dateKey);
        }

        function updateDayEvents(date, dateKey) {
            const eventsContainer = document.getElementById('events-' + dateKey);
            if (!eventsContainer) return;

            eventsContainer.innerHTML = '';
            const dayOfWeek = date.getDay();
            
            if ([1, 3, 5].includes(dayOfWeek)) {
                const reinaEvent = document.createElement('div');
                reinaEvent.className = 'event-item personal';
                reinaEvent.innerHTML = 'Reina<div class="sync-icon"></div>';
                reinaEvent.onclick = function(e) {
                    e.stopPropagation();
                    showPopup({
                        title: reinaSchedule[dayOfWeek],
                        time: '09:00',
                        type: 'personal',
                        description: 'Pulizie domestiche con Reina',
                        synced: false
                    });
                };
                eventsContainer.appendChild(reinaEvent);
            }

            if (dayOfWeek === 1) {
                const callEvent = document.createElement('div');
                callEvent.className = 'event-item work';
                callEvent.innerHTML = 'Call<div class="sync-icon"></div>';
                callEvent.onclick = function(e) {
                    e.stopPropagation();
                    showPopup({
                        title: 'Call Reaplace.it',
                        time: '18:00',
                        type: 'work',
                        description: 'Chiamata settimanale fissa con il cliente',
                        synced: false
                    });
                };
                eventsContainer.appendChild(callEvent);
            }

            if (tasks[dateKey] && Array.isArray(tasks[dateKey])) {
                tasks[dateKey].forEach(function(task) {
                    const taskEvent = document.createElement('div');
                    let eventClass = 'event-item ' + task.type;
                    if (task.source === 'google_calendar') {
                        eventClass += ' gcal';
                    }
                    if (task.synced) {
                        eventClass += ' synced';
                    }
                    taskEvent.className = eventClass;
                    
                    let displayText = task.title;
                    if (task.time) {
                        displayText = task.time + ' ' + displayText;
                    }
                    
                    taskEvent.innerHTML = displayText + '<div class="sync-icon"></div>';
                    taskEvent.onclick = function(e) {
                        e.stopPropagation();
                        showPopup(task);
                    };
                    eventsContainer.appendChild(taskEvent);
                });
            }
        }

        function selectDate(date) {
            document.querySelectorAll('.calendar-day.selected').forEach(function(day) {
                day.classList.remove('selected');
            });

            selectedDate = new Date(date);
            
            const dayElements = document.querySelectorAll('.calendar-day');
            dayElements.forEach(function(day) {
                const dayNumber = day.querySelector('.day-number');
                if (dayNumber && parseInt(dayNumber.textContent) === date.getDate()) {
                    day.classList.add('selected');
                }
            });

            updateDailySchedule();
            document.getElementById('taskDate').value = formatDateForInput(selectedDate);
        }

        function updateDailySchedule() {
            const schedule = document.getElementById('dailySchedule');
            const dateDisplay = document.getElementById('selectedDate');
            
            if (!schedule || !dateDisplay) return;
            
            const dateStr = formatDateDisplay(selectedDate);
            dateDisplay.textContent = dateStr;

            const dayOfWeek = selectedDate.getDay();
            const dateKey = formatDateKey(selectedDate);

            let scheduleHTML = '';

            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = hour.toString().padStart(2, '0') + ':00';
                let activities = [];

                if (fixedRoutine[timeSlot]) {
                    activities.push({
                        text: fixedRoutine[timeSlot],
                        type: 'fixed',
                        time: timeSlot,
                        synced: false
                    });
                }

                if ([1, 3, 5].includes(dayOfWeek) && hour === 9) {
                    activities.push({
                        text: reinaSchedule[dayOfWeek],
                        type: 'fixed',
                        time: timeSlot,
                        synced: false
                    });
                }

                if (dayOfWeek === 1 && timeSlot === '18:00') {
                    activities.push({
                        text: '📞 Call Reaplace.it',
                        type: 'fixed',
                        time: timeSlot,
                        synced: false
                    });
                }

                if (tasks[dateKey] && Array.isArray(tasks[dateKey])) {
                    tasks[dateKey].forEach(function(task) {
                        if (task.time && task.time.startsWith(timeSlot.substring(0, 2))) {
                            let activityType = 'flexible';
                            if (task.source === 'google_calendar') {
                                activityType = 'gcal';
                            }
                            activities.push({
                                text: task.title,
                                type: activityType,
                                time: task.time,
                                taskData: task,
                                synced: task.synced
                            });
                        }
                    });
                }

                if (activities.length > 0) {
                    scheduleHTML += '<div class="time-slot">' +
                        '<div class="time-label">' + timeSlot + '</div>' +
                        '<div class="time-content">';
                    
                    activities.forEach(function(activity) {
                        const syncIcon = activity.synced ? '<div class="sync-icon"></div>' : '';
                        scheduleHTML += '<div class="activity ' + activity.type + '" onclick="showPopup(' + 
                            JSON.stringify(activity.taskData || {
                                title: activity.text, 
                                time: activity.time, 
                                type: activity.type,
                                synced: activity.synced
                            }).replace(/"/g, '&quot;') + 
                            ')">' + activity.text + syncIcon + '</div>';
                    });
                    
                    scheduleHTML += '</div></div>';
                }
            }

            schedule.innerHTML = scheduleHTML || '<p>Nessuna attività programmata.</p>';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendarDisplay();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendarDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            selectedDate = new Date();
            updateDisplay();
            const today = formatDateDisplay(new Date());
            addChatMessage('📅 Tornato a oggi: ' + today);
        }

        function showPopup(event) {
            currentEvent = event;
            document.getElementById('popupTitle').textContent = event.title;
            document.getElementById('popupTime').textContent = event.time ? '🕐 ' + event.time : '';
            
            let description = '';
            if (event.description) {
                description = event.description;
            } else {
                description = event.title || 'Attività programmata';
            }
            
            if (event.synced) {
                description += '\n\n✅ Sincronizzato con Google Calendar';
            }
            if (event.source === 'google_calendar') {
                description += '\n\n📅 Importato da Google Calendar';
            }
            
            document.getElementById('popupDescription').textContent = description;
            document.getElementById('popupOverlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
            currentEvent = null;
        }

        function showHelp() {
            alert('🎯 AGENDA COMPLETA CON GOOGLE CALENDAR\n\n📅 CALENDARIO: Naviga tra i mesi e seleziona le date\n📝 PROGRAMMA: Visualizza il dettaglio del giorno selezionato\n➕ AGGIUNGI: Crea nuovi task rapidamente\n🔄 SINCRONIZZAZIONE: Integrazione bidirezionale con Google Calendar\n⚙️ CONFIGURAZIONE: Imposta Google Client ID e API Key per la sincronizzazione\n🤖 AI: Assistente per suggerimenti\n📊 EXPORT: Esporta i dati in CSV\n\n🏠 Include routine fisse, raccolta rifiuti e task personalizzati!\n\n🔗 INTEGRAZIONE GOOGLE CALENDAR:\n- Configura Google Cloud Console\n- Inserisci Client ID e API Key\n- Sincronizzazione automatica ogni 15 minuti\n- Import/Export eventi bidirezionale');
        }

        function initCalendar() {
            console.log('🔄 Inizializzando calendario...');
            
            // Controllo ambiente prima di tutto
            checkEnvironment();
            
            const savedConfig = localStorage.getItem('calendarConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                
                calendarConfig.googleClientId = config.googleClientId || '';
                calendarConfig.googleApiKey = config.googleApiKey || '';
                calendarConfig.calendarId = config.calendarId || 'primary';
                calendarConfig.syncInterval = config.syncInterval || 15;
                calendarConfig.lastSync = config.lastSync || null;
                
                if (config.syncedEvents && Array.isArray(config.syncedEvents)) {
                    calendarConfig.syncedEvents = new Set(config.syncedEvents);
                } else {
                    calendarConfig.syncedEvents = new Set();
                }
                
                addSyncLog('Configurazione caricata', 'info');
                
                if (calendarConfig.googleClientId && calendarConfig.googleApiKey) {
                    // Ritarda l'inizializzazione per permettere il controllo ambiente
                    setTimeout(() => {
                        initGoogleCalendarAPI();
                        startAutoSync();
                    }, 1000);
                }
            }
            
            startMidnightUpdate();
            
            updateDisplay();
            
            const taskDateField = document.getElementById('taskDate');
            if (taskDateField) {
                taskDateField.value = formatDateForInput(selectedDate);
            }
            
            updateStats();
            
            console.log('✅ Calendario inizializzato');
        }

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INIZIALIZZAZIONE WEBAPP CON GOOGLE CALENDAR ===');
            
            try {
                initDemoTasks();
                initCalendar();
                
                console.log('✅ WebApp inizializzata con successo');
                
                const popupOverlay = document.getElementById('popupOverlay');
                if (popupOverlay) {
                    popupOverlay.addEventListener('click', function(e) {
                        if (e.target === this) closePopup();
                    });
                }
                
                const configModal = document.getElementById('configModal');
                if (configModal) {
                    configModal.addEventListener('click', function(e) {
                        if (e.target === this) closeConfigModal();
                    });
                }
                
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') sendMessage();
                    });
                }

                const taskTitle = document.getElementById('taskTitle');
                if (taskTitle) {
                    taskTitle.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') addTask();
                    });
                }
                
                setTimeout(function() {
                    const today = new Date();
                    const todayFormatted = formatDateDisplay(today);
                    const todayKey = formatDateKey(today);
                    const todayTasks = tasks[todayKey] || [];
                    
                    addChatMessage(`🎯 CALENDARIO 2025 CON GOOGLE CALENDAR API - ${todayFormatted} ✅`);
                    
                    const wasteToday = todayTasks.find(task => task.title.includes('CARTA') || task.title.includes('VETRO') || task.title.includes('PLASTICA') || task.title.includes('ORGANICO') || task.title.includes('RESIDUO'));
                    if (wasteToday) {
                        addChatMessage(`${wasteToday.title} alle ${wasteToday.time}`);
                    }
                    
                    addChatMessage('📋 Raccolta differenziata aggiornata dal CSV corretto');
                    addChatMessage('🔗 Integrazione diretta Google Calendar API - Configura Client ID e API Key');
                    
                    if (calendarConfig.googleClientId && calendarConfig.googleApiKey) {
                        addChatMessage('✅ Google Calendar API configurata - Testa la connessione');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                addChatMessage('❌ Errore durante inizializzazione');
            }
        });

        console.log('🎉 JavaScript WebApp Agenda con Google Calendar Integration caricato!');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Agenda Calendar">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQWdlbmRhIENhbGVuZGFyIiwic2hvcnRfbmFtZSI6IkFnZW5kYSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzJjM2U1MCIsImJhY2tncm91bmRfY29sb3IiOiIjMmMzZTUwIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGRDYjNnOUlqQWdNQ0F6TWpBZ016SXdJajRLSUNBOGNtVmpkQ0IzYVdSMGFEMGlNekl3SWlCb1pXbG5hSFE5SWpNeU1DSWdabWxzYkQwaVl6STRNMWcxTWlJZ2NuZzlJakUySWk4K0NpQWdQSFJsZUhRZ2VEMGlOVEFpSUhrOUlqRXdNQ0lnWm1sc2JEMGlJMlpqWm1wbUlpQm1iMjUwTFdaaGJXbHNlVDBpVkdGb2IyMWhJaUJtYjI1MExYTnBlbVU5SWpNNElpQjBaWGgwTFdGdVkyaHZjajBpYldsa1pHeGxJaUFnUGprcGZDQkJaMlZ1WkdFK1BDOTBaWGgwUGdvOEwzTjJaejRLIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjMyMHgzMjAifV19">
    <title>La Mia Agenda - Gestione Completa con Google Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .sync-indicator.connected {
            background: #27ae60;
        }

        .sync-indicator.syncing {
            background: #f39c12;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .sync-buttons {
            display: flex;
            gap: 10px;
        }

        .sync-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .sync-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .sync-btn.config {
            background: #9b59b6;
        }

        .sync-btn.config:hover {
            background: #8e44ad;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 800px;
        }

        .calendar-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 30px;
            overflow-y: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .current-month {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #bdc3c7;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .calendar-day-header {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ecf0f1;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: #e8f4fd;
            transform: scale(1.02);
        }

        .calendar-day.selected {
            background: #3498db;
            color: white;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #bdc3c7;
        }

        .calendar-day.today {
            background: #f39c12;
            color: white;
            font-weight: bold;
        }

        .calendar-day.today .day-number {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px auto;
        }

        .day-number {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .day-events {
            font-size: 0.8em;
        }

        .event-item {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .event-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .event-item.work { background: #3498db; }
        .event-item.personal { background: #27ae60; }
        .event-item.medical { background: #e67e22; }
        .event-item.garden { background: #16a085; }
        .event-item.house { background: #8e44ad; }
        .event-item.gcal { background: #4285f4; }

        .event-item .sync-icon {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            border: 1px solid white;
            display: none;
        }

        .event-item.synced .sync-icon {
            display: block;
        }

        .daily-schedule {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .schedule-header {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-actions {
            display: flex;
            gap: 10px;
        }

        .sync-day-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .sync-day-btn:hover {
            background: #229954;
        }

        .time-slot {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .time-slot:hover {
            background: #f8f9fa;
        }

        .time-label {
            width: 80px;
            font-weight: bold;
            color: #34495e;
            font-size: 1.1em;
        }

        .time-content {
            flex: 1;
            padding-left: 15px;
        }

        .activity {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .activity:hover {
            background: #e8f4fd;
            transform: translateX(5px);
        }

        .activity.fixed {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .activity.flexible {
            border-left-color: #27ae60;
            background: #f2fdf2;
        }

        .activity.gcal {
            border-left-color: #4285f4;
            background: #e8f0fe;
        }

        .sidebar h3 {
            color: #ecf0f1;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .integration-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #34495e;
            border-radius: 10px;
            border: 2px solid #4285f4;
        }

        .integration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .integration-title {
            color: #4285f4;
            font-size: 1.2em;
            font-weight: bold;
        }

        .connection-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #27ae60;
            color: white;
        }

        .connection-status.disconnected {
            background: #e74c3c;
            color: white;
        }

        .integration-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .integration-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
        }

        .integration-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .integration-btn.config {
            background: #9b59b6;
        }

        .integration-btn.config:hover {
            background: #8e44ad;
        }

        .integration-btn.test {
            background: #f39c12;
        }

        .integration-btn.test:hover {
            background: #e67e22;
        }

        .sync-log {
            background: #2c3e50;
            border-radius: 6px;
            padding: 10px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 12px;
            color: #bdc3c7;
        }

        .sync-log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid #34495e;
        }

        .sync-log-entry:last-child {
            border-bottom: none;
        }

        .sync-log-entry.success {
            color: #27ae60;
        }

        .sync-log-entry.error {
            color: #e74c3c;
        }

        .sync-log-entry.info {
            color: #3498db;
        }

        .quick-add {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ecf0f1;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: #34495e;
            color: white;
            border: 2px solid transparent;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: #2c3e50;
        }

        .form-control::placeholder {
            color: #bdc3c7;
        }

        select.form-control {
            cursor: pointer;
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .form-check input {
            margin-right: 8px;
        }

        .form-check label {
            color: #bdc3c7;
            font-size: 14px;
            margin-bottom: 0;
        }

        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .export-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #34495e;
            border-radius: 10px;
            border: 2px solid #16a085;
        }

        .btn-export {
            background: #16a085;
            margin-bottom: 10px;
        }

        .btn-export:hover {
            background: #138d75;
        }

        .routine-list {
            margin-bottom: 30px;
        }

        .routine-item {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #f39c12;
        }

        .routine-time {
            font-weight: bold;
            color: #f39c12;
            font-size: 1.1em;
        }

        .routine-task {
            color: #ecf0f1;
            margin-top: 5px;
        }

        .ai-chat {
            background: #1a252f;
            border-radius: 10px;
            padding: 20px;
        }

        .chat-header {
            color: #3498db;
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }

        .chat-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: #2c3e50;
            color: white;
            margin-bottom: 10px;
        }

        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .chat-message {
            background: #34495e;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-form-group {
            margin-bottom: 20px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .modal-form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            color: #2c3e50;
            transition: border-color 0.3s;
        }

        .modal-form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-form-control::placeholder {
            color: #95a5a6;
        }

        .modal-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .modal-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .modal-btn.save {
            background: #27ae60;
        }

        .modal-btn.save:hover {
            background: #219a52;
        }

        .modal-btn.cancel {
            background: #95a5a6;
        }

        .modal-btn.cancel:hover {
            background: #7f8c8d;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-help {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c5460;
        }

        .modal-help h4 {
            margin-bottom: 10px;
            color: #0c5460;
        }

        .modal-help ol {
            margin-left: 20px;
        }

        .modal-help li {
            margin-bottom: 5px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: popupSlideIn 0.3s ease-out;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .popup-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s;
        }

        .popup-close:hover {
            color: #e74c3c;
        }

        .popup-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .popup-time {
            font-size: 1.2em;
            color: #3498db;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .popup-description {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .popup-actions {
            display: flex;
            gap: 10px;
        }

        .floating-help {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .floating-help:hover {
            transform: scale(1.1);
            background: #2980b9;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                margin: 0;
                min-height: 100vh;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .sync-status {
                position: static;
                justify-content: center;
                margin-top: 15px;
                flex-wrap: wrap;
            }

            .sync-buttons {
                margin-top: 10px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .calendar-section {
                padding: 15px;
                order: 1;
            }

            .sidebar {
                order: 2;
                padding: 20px 15px;
            }

            .calendar-grid {
                gap: 1px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }

            .day-events {
                font-size: 0.7em;
            }

            .event-item {
                padding: 1px 4px;
                font-size: 0.65em;
                margin-bottom: 1px;
            }

            .form-control {
                font-size: 16px;
                padding: 14px;
            }

            .btn {
                font-size: 16px;
                padding: 14px 20px;
                touch-action: manipulation;
            }

            .modal-content {
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .sync-btn, .nav-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .floating-help {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.2em;
                touch-action: manipulation;
            }

            .time-slot {
                flex-direction: column;
                align-items: flex-start;
            }

            .time-label {
                width: 100%;
                margin-bottom: 5px;
                border-bottom: 1px solid #ecf0f1;
                padding-bottom: 5px;
            }

            .time-content {
                padding-left: 0;
                width: 100%;
            }

            .activity {
                margin-bottom: 8px;
            }

            /* Migliora touch per iOS */
            .calendar-day, .event-item, .activity, .btn {
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }

            /* Previeni zoom accidentale */
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* Stili per PWA - fullscreen */
        @media all and (display-mode: standalone) {
            .header {
                padding-top: 40px; /* Spazio per status bar iOS */
            }
        }

        /* Dark mode per dispositivi che lo supportano */
        @media (prefers-color-scheme: dark) {
            .container {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .calendar-section {
                background: #2d2d2d;
            }
            
            .calendar-day {
                background: #3a3a3a;
                color: #ffffff;
            }
            
            .daily-schedule {
                background: #2d2d2d;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗓️ La Mia Agenda Completa</h1>
            <p>Gestione ottimale tempo lavorativo e personale con Google Calendar</p>
            
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatusText">Disconnesso</span>
                <div class="sync-buttons">
                    <button class="sync-btn test" onclick="testConnection()">Test</button>
                    <button class="sync-btn config" onclick="openConfigModal()">Config</button>
                    <button class="sync-btn" onclick="manualSync()">Sync</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">←</button>
                        <button class="nav-btn" onclick="nextMonth()">→</button>
                        <button class="nav-btn" onclick="goToToday()">Oggi</button>
                    </div>
                    <div class="current-month" id="currentMonth"></div>
                </div>

                <div class="calendar-grid" id="calendar"></div>

                <div class="daily-schedule">
                    <div class="schedule-header">
                        <span>📅 Programma del <span id="selectedDate"></span></span>
                        <div class="sync-actions">
                            <button class="sync-day-btn" onclick="syncDay()">📤 Sync Giorno</button>
                            <button class="sync-day-btn" onclick="importDay()">📥 Import</button>
                        </div>
                    </div>
                    <div id="dailySchedule"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="tasksToday">0</div>
                        <div class="stat-label">Task Oggi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="syncedEvents">0</div>
                        <div class="stat-label">Eventi Sync</div>
                    </div>
                </div>

                <div class="integration-section">
                    <div class="integration-header">
                        <div class="integration-title">📅 Google Calendar</div>
                        <div class="connection-status disconnected" id="connectionStatus">Disconnesso</div>
                    </div>
                    <div class="integration-actions">
                        <button class="integration-btn config" onclick="openConfigModal()">⚙️ Config</button>
                        <button class="integration-btn test" onclick="testConnection()">🔌 Test</button>
                    </div>
                    <div class="sync-log" id="syncLog">
                        <div class="sync-log-entry info">Sistema pronto per la configurazione</div>
                    </div>
                </div>

                <div class="quick-add">
                    <h3>➕ Aggiungi Veloce</h3>
                    <div class="form-group">
                        <label for="taskTitle">Cosa devi fare?</label>
                        <input type="text" id="taskTitle" class="form-control" placeholder="Es: Vigili urbani, Call cliente...">
                    </div>
                    <div class="form-group">
                        <label for="taskDate">Quando?</label>
                        <input type="date" id="taskDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskTime">A che ora?</label>
                        <input type="time" id="taskTime" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskType">Categoria</label>
                        <select id="taskType" class="form-control">
                            <option value="work">💼 Lavoro</option>
                            <option value="personal">👤 Personale</option>
                            <option value="medical">💊 Cure Annamaria</option>
                            <option value="garden">🌱 Orto/Giardino</option>
                            <option value="house">🏠 Casa</option>
                            <option value="babu">🐕 Babu</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="syncToCalendar" checked>
                        <label for="syncToCalendar">Sincronizza con Google Calendar</label>
                    </div>
                    <button class="btn" onclick="addTask()">Aggiungi Task</button>
                </div>

                <div class="export-section">
                    <h3>📤 Export & Sync</h3>
                    <button class="btn btn-export" onclick="exportToCSV()">📊 Esporta CSV</button>
                    <button class="btn btn-export" onclick="sync
